<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å•¤é…’è‡ºä¸­ç‡Ÿæ¥­è™•-é›†é»æ´»å‹•</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; text-align: center; }
        .card { max-width: 400px; margin: 0 auto; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-custom { background-color: #00B900; color: white; width: 100%; padding: 12px; font-size: 18px; border: none; border-radius: 8px; }
        .btn-custom:hover { background-color: #009900; color: white; }
        #status { margin-top: 15px; color: #666; font-size: 14px; }
        .loading { display: none; }
    </style>
</head>
<body>

    <div class="card p-4">
        <h3 class="mb-3">ğŸº é›†é»æ´»å‹•æ¸¬è©¦</h3>
        <p>æ­¡è¿åƒåŠ ï¼é»æ“Šä¸‹æ–¹æŒ‰éˆ•é ˜å–é»æ•¸ã€‚</p>
        
        <div id="userInfo" class="mb-3">
            <p>ä½ å¥½ï¼Œ<span id="displayName">è®€å–ä¸­...</span></p>
        </div>

        <button id="btnPoints" class="btn-custom" onclick="sendPoints()">
            é ˜å– 10 é»
        </button>

        <p id="status"></p>
        <div id="loader" class="spinner-border text-success loading" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script>
        // ================= è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) =================
        
        // 1. å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (å‰›å‰›éƒ¨ç½²çš„é‚£ä¸²)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYI4M2RuswYcxoMy98Gr8WLinypnvZwrYAwtHsD84rX0unB26FKKx4u0dcuB9Ojo62/exec"; 

        // 2. å¡«å…¥æ‚¨çš„ LIFF ID (ç­‰ç­‰æ•™æ‚¨æ€éº¼ç”³è«‹ï¼Œå…ˆç•™ç©ºæˆ–å¡«å…¥å‡çš„)
        const MY_LIFF_ID = "0918332817"; 

        // ======================================================

        // åˆå§‹åŒ– LIFF
        function initializeLiff() {
            liff.init({ liffId: MY_LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        getUserProfile();
                    }
                })
                .catch((err) => {
                    document.getElementById('status').innerText = "LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + err;
                });
        }

        // å–å¾—ä½¿ç”¨è€…è³‡æ–™
        function getUserProfile() {
            liff.getProfile()
                .then(profile => {
                    document.getElementById('displayName').innerText = profile.displayName;
                })
                .catch((err) => {
                    console.error('å€‹è³‡æŠ“å–éŒ¯èª¤', err);
                });
        }

        // å‚³é€é»æ•¸çµ¦ Google Sheet
        function sendPoints() {
            const btn = document.getElementById('btnPoints');
            const loader = document.getElementById('loader');
            const status = document.getElementById('status');

            // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";
            loader.style.display = 'inline-block';

            liff.getProfile().then(profile => {
                const payload = {
                    userId: profile.userId,
                    points: 10,  // é€™è£¡è¨­å®šæ¯æ¬¡çµ¦å¹¾é»
                    note: "LIFFå‰ç«¯é»æ“Š"
                };

                // ä½¿ç”¨ fetch ç™¼é€è³‡æ–™ (åˆ©ç”¨ text/plain é¿é–‹ CORS é æª¢)
                fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "no-cors", // é‡è¦ï¼šGAS çš„ç‰¹æ€§éœ€è¦è¨­ç‚º no-corsï¼Œé›–ç„¶æ‹¿ä¸åˆ°å›å‚³å€¼ï¼Œä½†èƒ½æˆåŠŸå¯«å…¥
                    headers: {
                        "Content-Type": "text/plain"
                    },
                    body: JSON.stringify(payload)
                }).then(() => {
                    // å› ç‚º no-cors æ¨¡å¼ç„¡æ³•è®€å–å›å‚³å…§å®¹ï¼Œæˆ‘å€‘å‡è¨­åªè¦æ²’å ±éŒ¯å°±æ˜¯æˆåŠŸ
                    status.innerText = "âœ… é›†é»æˆåŠŸï¼è«‹æŸ¥çœ‹ Google Sheet";
                    status.style.color = "green";
                    
                    // é‡ç½®æŒ‰éˆ•
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerText = "å†é ˜ä¸€æ¬¡ (æ¸¬è©¦ç”¨)";
                        loader.style.display = 'none';
                    }, 2000);
                }).catch(err => {
                    status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err;
                    status.style.color = "red";
                    btn.disabled = false;
                    loader.style.display = 'none';
                });
            });
        }

        // ç¶²é è¼‰å…¥å¾Œç«‹å³åŸ·è¡Œ
        window.onload = initializeLiff;
    </script>
</body>
</html>