<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>(ä¸­éƒ¨)å°å•¤é›†é»æ´»å‹•</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-color: #006633; --accent-color: #FFC107; --bg-color: #f4f6f8; }
        body { background-color: var(--bg-color); font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 100px; /* å¢åŠ åº•éƒ¨ç©ºé–“çµ¦è­¦èª */ }
        
        .header-section {
            background: linear-gradient(135deg, #004d26 0%, #008040 100%); color: white; padding: 25px 20px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,80,0,0.25); position: relative; overflow: hidden;
        }
        .header-bg-circle { position: absolute; top: -30px; right: -30px; width: 180px; height: 180px; background: rgba(255,255,255,0.08); border-radius: 50%; }
        .user-greeting { font-size: 0.95rem; opacity: 0.9; margin-bottom: 5px; }
        .store-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; backdrop-filter: blur(4px); }
        .balance-card { margin-top: 20px; text-align: center; }
        .balance-number { font-size: 3.8rem; font-weight: 800; color: var(--accent-color); text-shadow: 0 2px 5px rgba(0,0,0,0.2); line-height: 1; }
        .balance-label { font-size: 0.9rem; opacity: 0.8; letter-spacing: 1px; }

        .custom-card { background: white; border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 15px; padding: 25px 20px; }
        
        /* è½‰ç›¤æ¨£å¼ */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 0 auto 20px auto; }
        .wheel {
            width: 100%; height: 100%; border-radius: 50%; border: 10px solid #004d26;
            position: relative; overflow: hidden; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            background: conic-gradient(#FFC107 0% 16.66%, #ffffff 16.66% 33.33%, #FFC107 33.33% 50%, #ffffff 50% 66.66%, #FFC107 66.66% 83.33%, #ffffff 83.33% 100%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        @keyframes spin-loading { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .wheel-loading { animation: spin-loading 0.6s linear infinite; }
        .wheel-text { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; transform-origin: 0 0; text-align: center; padding-top: 15px; font-weight: bold; font-size: 0.9rem; color: #333; }
        .txt-1 { transform: rotate(30deg) translateY(-140px) translateX(-50%); } 
        .txt-2 { transform: rotate(90deg) translateY(-140px) translateX(-50%); } 
        .txt-3 { transform: rotate(150deg) translateY(-140px) translateX(-50%); } 
        .txt-4 { transform: rotate(210deg) translateY(-140px) translateX(-50%); } 
        .txt-5 { transform: rotate(270deg) translateY(-140px) translateX(-50%); } 
        .txt-6 { transform: rotate(330deg) translateY(-140px) translateX(-50%); } 
        .wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid #dc3545; z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .wheel-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: white; border-radius: 50%; border: 4px solid #004d26; color: #004d26; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; z-index: 5; box-shadow: 0 0 10px rgba(0,0,0,0.2); cursor: pointer; }
        .wheel-btn:active { transform: translate(-50%, -50%) scale(0.95); }

        /* å°è¦½åˆ—èˆ‡è­¦èªæ¨£å¼ */
        .bottom-nav { 
            position: fixed; 
            bottom: 60px; /* æ”¹ç‚º 60pxï¼Œè®“ä½çµ¦è­¦èª */
            left: 50%; transform: translateX(-50%); 
            width: 95%; max-width: 400px; 
            background: white; border-radius: 50px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            display: flex; padding: 5px; z-index: 999; 
        }
        .nav-btn { flex: 1; text-align: center; padding: 12px 0; border-radius: 40px; color: #aaa; font-weight: bold; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85rem; }
        .nav-btn.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(0,102,51,0.3); }

        /* å›ºå®šåº•éƒ¨è­¦èª */
        .warning-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: black; color: white;
            text-align: center; padding: 12px 0;
            font-size: 1.1rem; font-weight: bold;
            z-index: 9999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        .warning-icon { color: #dc3545; margin: 0 5px; font-size: 1.2rem; }

        .form-control-custom { border: 2px solid #eee; border-radius: 12px; padding: 14px; font-size: 1.1rem; text-align: center; background-color: #fafafa; }
        .form-control-custom:focus { border-color: var(--primary-color); background-color: #fff; box-shadow: 0 0 0 3px rgba(0,102,51,0.1); }
        .btn-action { width: 100%; background: var(--primary-color); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; font-size: 1.1rem; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,102,51,0.3); transition: background-color 0.3s; }
        .btn-action:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-redeem { width: 100%; padding: 6px; font-size: 0.9rem; border-radius: 8px; }
        
        .d-none { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è¨»å†Šè¡¨å–®å°ˆç”¨æ¨£å¼ */
        .reg-label { text-align: left; width: 100%; margin-top: 10px; font-weight: bold; color: #333; }
        .reg-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; background: #f9f9f9; }
        .reg-check-group { display: flex; align-items: start; margin-top: 15px; text-align: left; font-size: 0.9rem; }
        .reg-check-group input { margin-top: 4px; margin-right: 8px; transform: scale(1.2); }
        .reg-link { color: #006633; text-decoration: underline; cursor: pointer; }
        
        .reward-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .reward-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; transition: transform 0.2s; }
        .reward-card:active { transform: scale(0.98); }
        .reward-img { width: 100%; height: 140px; object-fit: cover; background-color: #f0f0f0; }
        .reward-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .reward-title { font-size: 0.95rem; font-weight: bold; color: #333; margin-bottom: 5px; line-height: 1.3; height: 2.6em; overflow: hidden; }
        .reward-meta { font-size: 0.8rem; color: #666; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .store-select-container { background-color: #fff; padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color); }
        .form-select-custom { border: 2px solid #eee; border-radius: 8px; padding: 10px; font-size: 1rem; width: 100%; background-color: #fafafa; }
        .prize-link { cursor: pointer; color: #0d6efd; transition: color 0.2s; text-decoration: none; display: inline-block; padding: 5px; }
    </style>
</head>
<body>

    <div class="warning-footer">
        ç¦æ­¢é…’é§• <i class="fas fa-ban warning-icon"></i> å®‰å…¨èª ç„¡åƒ¹ é…’å¾Œæ‰¾ä»£é§•
    </div>

    <div class="header-section">
        <div class="header-bg-circle"></div>
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="user-greeting" id="userGreeting">Hi, æœƒå“¡</div>
                <div style="font-weight:bold; font-size:1.2rem;">
                    <i class="fas fa-beer"></i> å°ç£å•¤é…’
                </div>
            </div>
            <div class="store-badge" id="storeDisplay">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
        <div class="balance-card">
            <div class="balance-number" id="headerPoints">...</div>
            <div class="balance-label">ç›®å‰æŒæœ‰é»æ•¸</div>
        </div>
    </div>

    <div class="container mt-3">
        <div id="page-earn" class="fade-in">
            <div class="custom-card">
                <h5 class="fw-bold mb-4" style="color:#333;"><i class="fas fa-qrcode me-2 text-success"></i>æƒç¢¼é›†é»</h5>
                <div class="mb-3">
                    <label class="text-muted small mb-2 fw-bold">æ¶ˆè²»ç“¶æ•¸ / é‡‘é¡</label>
                    <input type="number" id="inputPoints" class="form-control form-control-custom" placeholder="è«‹è¼¸å…¥æœ¬æ¬¡æ¶ˆè²»å°å•¤ç“¶æ•¸" min="1">
                </div>
                <div class="mb-3">
                    <label class="text-muted small mb-2 fw-bold">è«‹åº—å“¡è¼¸å…¥æ ¸éŠ·ç¢¼</label>
                    <input type="password" id="inputPinEarn" class="form-control form-control-custom" placeholder="PIN Code" maxlength="4">
                </div>
                <button id="btnEarn" class="btn-action" onclick="doEarn()" disabled>é€£ç·šä¸­...</button>
            </div>
            <div class="custom-card py-3 text-center" style="background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;">
                <small><i class="fas fa-info-circle me-1"></i> è«‹å‘åº—å“¡å‡ºç¤ºæœ¬ç•«é¢é€²è¡Œé›†é»</small>
            </div>
        </div>

        <div id="page-redeem" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;å¥½ç¦®å…Œæ›å°ˆå€</h5>
            <div id="storeSelectArea" class="store-select-container d-none">
                <label class="text-muted small mb-1 fw-bold"><i class="fas fa-store-alt me-1"></i> æŸ¥è©¢å„åº—åº«å­˜</label>
                <select id="storeSelect" class="form-select form-select-custom" onchange="loadRewards()">
                    <option value="" disabled selected>è¼‰å…¥åº—å®¶æ¸…å–®ä¸­...</option>
                </select>
            </div>
            <div id="rewardList" class="reward-grid">
                <div class="text-center w-100 py-4" style="grid-column: span 2;"><div class="spinner-border text-success" role="status"></div></div>
            </div>
            <div style="height: 100px;"></div> 
        </div>

        <div id="page-game" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;å¹¸é‹å¤§è½‰ç›¤</h5>
            <div class="custom-card text-center" style="background: #e8f5e9;">
                <p class="mb-2 fw-bold" style="color:#004d26;">ä»¥å°åšå¤§ï¼æ¯æ¬¡åªéœ€ <span class="text-danger">2</span> é»</p>
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="wheel" id="wheel">
                        <div class="wheel-text txt-1">æ‹‰æ¡¿<br>å†°æ¡¶</div>
                        <div class="wheel-text txt-2">éŠ˜è¬<br>æƒ é¡§</div>
                        <div class="wheel-text txt-3">20å‹<br>è¡Œæç®±</div>
                        <div class="wheel-text txt-4">éŠ˜è¬<br>æƒ é¡§</div>
                        <div class="wheel-text txt-5">éŠ˜è¬<br>æƒ é¡§</div>
                        <div class="wheel-text txt-6">éŠ˜è¬<br>æƒ é¡§</div>
                    </div>
                    <div class="wheel-btn" onclick="doPlayGame()" id="spinBtn">GO</div>
                </div>
                
                <div class="mt-3">
                    <div class="prize-link" onclick="showPrizeImage('æ‹‰æ¡¿å†°æ¡¶', 'https://github.com/TBa930044/twbeertaichung/blob/main/ice.png?raw=true')">
                        <i class="fas fa-gift"></i> å¤§çï¼šæ‹‰æ¡¿å†°æ¡¶ (æ¥µç¨€æœ‰) <i class="fas fa-search-plus small"></i>
                    </div>
                    <br>
                    <div class="prize-link" onclick="showPrizeImage('20å‹ç©ºè»è—è¡Œæç®±', 'https://eshop.ttl.com.tw/uploadphoto/images/thumbs/0000487_taiwan-beer-x-eminent-20_600.jpeg')">
                        <i class="fas fa-suitcase"></i> äºŒçï¼š20å‹ç©ºè»è—è¡Œæç®± <i class="fas fa-search-plus small"></i>
                    </div>
                </div>
            </div>
            <div style="height: 100px;"></div> 
        </div>

        <div id="page-history" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;è¿‘æœŸäº¤æ˜“ç´€éŒ„</h5>
            <div id="historyList" class="history-list">
                <div class="text-center w-100 py-4"><div class="spinner-border text-success" role="status"></div></div>
            </div>
            <div style="height: 100px;"></div> 
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" id="tab-earn" onclick="switchTab('earn')"><i class="fas fa-camera"></i><br>é›†é»</div>
        <div class="nav-btn" id="tab-redeem" onclick="switchTab('redeem')"><i class="fas fa-gift"></i><br>å…Œæ›</div>
        <div class="nav-btn" id="tab-game" onclick="switchTab('game')"><i class="fas fa-dharmachakra"></i><br>éŠæˆ²</div>
        <div class="nav-btn" id="tab-history" onclick="switchTab('history')"><i class="fas fa-history"></i><br>ç´€éŒ„</div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYI4M2RuswYcxoMy98Gr8WLinypnvZwrYAwtHsD84rX0unB26FKKx4u0dcuB9Ojo62/exec"; 
        const MY_LIFF_ID = "2008765350-4KBTGWMz"; 
        
        const urlParams = new URLSearchParams(window.location.search);
        let storeParam = urlParams.get('store');
        if (!storeParam && window.location.hash) {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            storeParam = hashParams.get('store');
        }
        if (storeParam) { localStorage.setItem('savedStoreId', storeParam); } 
        else { const saved = localStorage.getItem('savedStoreId'); if (saved) storeParam = saved; }

        const currentStoreId = storeParam || 'store01'; 
        let currentUserProfile = null;
        const isViewOnly = (currentStoreId === 'store00');

        window.onload = function() {
            document.getElementById('headerPoints').innerText = "è¼‰å…¥ä¸­..."; 
            document.getElementById('headerPoints').style.fontSize = "1.5rem";

            if (isViewOnly) {
                document.getElementById('storeDisplay').innerHTML = `<i class="fas fa-search me-1"></i> é›†é»æŸ¥è©¢`;
                document.getElementById('inputPoints').disabled = true;
                document.getElementById('inputPoints').placeholder = "åƒ…ä¾›æŸ¥è©¢";
                document.getElementById('inputPinEarn').disabled = true;
                document.getElementById('inputPinEarn').placeholder = "è«‹è‡³é–€å¸‚é›†é»";
                const btn = document.getElementById('btnEarn');
                btn.disabled = true;
                btn.innerText = "æ­¤æ¨¡å¼åƒ…ä¾›æŸ¥è©¢é¤˜é¡";
                document.getElementById('storeSelectArea').classList.remove('d-none');
                loadStoreList(); 
            } else {
                document.getElementById('storeDisplay').innerHTML = `<i class="fas fa-map-marker-alt me-1"></i> ${currentStoreId}`;
            }

            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    let loginRedirect = window.location.href;
                    if(currentStoreId && !window.location.search.includes('store')) {
                         loginRedirect = loginRedirect.split('?')[0] + '?store=' + currentStoreId;
                    }
                    liff.login({ redirectUri: loginRedirect });
                } else {
                    liff.getProfile().then(profile => { 
                        currentUserProfile = profile;
                        if(profile.displayName) document.getElementById('userGreeting').innerText = `Hi, ${profile.displayName}`;
                        if(!isViewOnly) {
                            const btn = document.getElementById('btnEarn');
                            btn.disabled = false;
                            btn.innerText = "ç¢ºèªé›†é»";
                        }
                        // æª¢æŸ¥é¤˜é¡ + æ˜¯å¦è¨»å†Š
                        checkBalanceAndRegister(profile.userId);
                    });
                }
            }).catch(console.error);
        };

        // --- æ–°å¢ï¼šæª¢æŸ¥è¨»å†Šç‹€æ…‹ ---
        function checkBalanceAndRegister(userId) {
            fetch(GAS_API_URL, { 
                method: "POST", headers: { "Content-Type": "text/plain" }, 
                body: JSON.stringify({ action: 'checkBalance', userId: userId }) 
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('headerPoints').style.fontSize = "3.8rem";
                if(data.userBalance !== undefined) updateBalanceUI(data.userBalance);
                
                // å¦‚æœå¾Œç«¯å›å‚³å°šæœªè¨»å†Šï¼Œè·³å‡ºè¨»å†Šè¦–çª—
                if (data.isRegistered === false) {
                    showRegistrationModal(userId);
                }
            })
            .catch(err => { document.getElementById('headerPoints').innerText = "---"; });
        }

        // --- æ–°å¢ï¼šè¨»å†Šå½ˆçª— ---
        function showRegistrationModal(userId) {
            Swal.fire({
                title: 'ç¬¬ä¸€æ¬¡æƒæå‰<br>è«‹å…ˆå¡«å¯«åŸºæœ¬è³‡æ–™',
                html: `
                    <div style="font-size:0.9rem; color:#666; margin-bottom:15px;">ä»¥ä½œç‚ºå¾ŒçºŒè´ˆå“å¯„é€ä½¿ç”¨</div>
                    
                    <label class="reg-label">çœŸå¯¦å§“å</label>
                    <input id="reg-name" class="reg-input" placeholder="ç‹å°æ˜">
                    
                    <label class="reg-label">é€£çµ¡é›»è©±</label>
                    <input id="reg-phone" class="reg-input" type="tel" placeholder="0912345678">
                    
                    <label class="reg-label">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input id="reg-dob" class="reg-input" type="date">
                    
                    <div class="reg-check-group">
                        <input type="checkbox" id="check-age">
                        <label for="check-age">æˆ‘æ˜¯è¨­ç±ä¸”å±…ä½æ–¼ä¸­è¯æ°‘åœ‹ä¹‹å¹´æ»¿18è¶³æ­²æœ¬åœ‹å…¬æ°‘</label>
                    </div>
                    
                    <div class="reg-check-group">
                        <input type="checkbox" id="check-terms">
                        <label for="check-terms">æˆ‘å·²è©³é–±äº†è§£ä¸¦åŒæ„éµå®ˆæœ¬æ´»å‹•æ‰€å…¬å¸ƒçš„ <span class="reg-link" onclick="showTerms()">æ´»å‹•è¾¦æ³•æš¨å€‹äººè³‡æ–™åŒæ„è²æ˜</span></label>
                    </div>
                `,
                confirmButtonText: 'ç¢ºèªé€å‡º',
                confirmButtonColor: '#006633',
                allowOutsideClick: false,
                allowEscapeKey: false,
                width: '90%',
                preConfirm: () => {
                    const name = document.getElementById('reg-name').value;
                    const phone = document.getElementById('reg-phone').value;
                    const dob = document.getElementById('reg-dob').value;
                    const checkAge = document.getElementById('check-age').checked;
                    const checkTerms = document.getElementById('check-terms').checked;

                    if (!name || !phone || !dob) { Swal.showValidationMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½'); return false; }
                    if (!checkAge) { Swal.showValidationMessage('å¿…é ˆå¹´æ»¿18æ­²æ‰èƒ½åƒåŠ '); return false; }
                    if (!checkTerms) { Swal.showValidationMessage('è«‹åŒæ„æ´»å‹•è¾¦æ³•'); return false; }

                    // è¨ˆç®—å¹´é½¡
                    const today = new Date();
                    const birthDate = new Date(dob);
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; }
                    
                    if (age < 18) { Swal.showValidationMessage('æŠ±æ­‰ï¼Œæ‚¨æœªæ»¿18æ­²ï¼Œç„¡æ³•åƒåŠ æœ¬æ´»å‹•ã€‚'); return false; }

                    return { name: name, phone: phone, dob: dob };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // é€å‡ºè¨»å†Šè³‡æ–™
                    registerUser(userId, result.value);
                }
            });
        }

        function registerUser(userId, data) {
            Swal.fire({ title: 'è³‡æ–™å»ºç«‹ä¸­...', didOpen: () => { Swal.showLoading() } });
            fetch(GAS_API_URL, { 
                method: "POST", headers: { "Content-Type": "text/plain" }, 
                body: JSON.stringify({ 
                    action: 'registerUser', 
                    userId: userId, 
                    name: data.name, 
                    phone: data.phone, 
                    dob: data.dob 
                }) 
            })
            .then(res => res.json())
            .then(resData => {
                if (resData.status === 'success') {
                    Swal.fire({ icon: 'success', title: 'è¨»å†ŠæˆåŠŸ', text: 'æ­¡è¿åƒåŠ æ´»å‹•ï¼', confirmButtonColor: '#006633' });
                } else {
                    Swal.fire('éŒ¯èª¤', 'è¨»å†Šå¤±æ•—ï¼Œè«‹é‡è©¦', 'error').then(() => showRegistrationModal(userId));
                }
            });
        }

        function showTerms() {
            Swal.fire({
                title: 'æ´»å‹•è¾¦æ³•æš¨å€‹è³‡è²æ˜',
                html: '<div style="text-align:left; max-height:300px; overflow-y:auto; font-size:0.9rem;">é€™è£¡è«‹æ”¾å…¥æ‚¨çš„è©³ç´°æ´»å‹•è¾¦æ³•èˆ‡å€‹è³‡è²æ˜æ–‡å­—...<br><br>1. æœ¬æ´»å‹•é™å¹´æ»¿18æ­²åƒåŠ ã€‚<br>2. å€‹è³‡å°‡åƒ…ç”¨æ–¼æœ¬æ´»å‹•è´ˆå“å¯„é€ã€‚<br>3. ç¦æ­¢é…’é§•ï¼Œæœªæ»¿18æ­²ç¦æ­¢é£²é…’ã€‚</div>',
                confirmButtonColor: '#006633'
            });
        }

        // --- ä»¥ä¸‹ç¶­æŒåŸæœ‰çš„éŠæˆ²èˆ‡åŠŸèƒ½ ---
        function showPrizeImage(title, imgUrl) {
            Swal.fire({
                title: title,
                html: `<div class="mb-3"><button onclick="Swal.close()" class="btn btn-success w-100 fw-bold" style="background-color: #006633; border-color: #006633; padding: 12px; font-size: 1.1rem;"><i class="fas fa-times-circle"></i> é—œé–‰åœ–ç‰‡</button></div><img src="${imgUrl}" style="width:100%; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">`,
                showConfirmButton: false, showCloseButton: false, allowOutsideClick: true, customClass: { popup: 'swal-wide' }
            });
        }

        let isSpinning = false;
        function doPlayGame() {
            if (isSpinning) return;
            if (!currentUserProfile) return;
            Swal.fire({
                title: 'å¹¸é‹å¤§è½‰ç›¤', text: "ç¢ºå®šè¦æ‰£é™¤ 2 é»é€²è¡ŒæŠ½çå—ï¼Ÿ", icon: 'question', showCancelButton: true, confirmButtonText: 'é–‹å§‹è½‰å‹•ï¼', cancelButtonText: 'ç­‰ç­‰', confirmButtonColor: '#006633'
            }).then((result) => { if (result.isConfirmed) startSpin(); });
        }

function startSpin() {
            if (isSpinning) return;
            isSpinning = true;
            document.getElementById('spinBtn').style.opacity = 0.5;
            
            const wheel = document.getElementById('wheel');
            wheel.style.transition = 'none';
            wheel.classList.add('wheel-loading');

            fetch(GAS_API_URL, { 
                method: "POST", headers: { "Content-Type": "text/plain" }, 
                body: JSON.stringify({ action: 'playGame', userId: currentUserProfile.userId, displayName: currentUserProfile.displayName, storeId: currentStoreId }) 
            })
            .then(res => res.json())
            .then(data => {
                if(data.status !== 'success') {
                    wheel.classList.remove('wheel-loading');
                    Swal.fire('éŒ¯èª¤', data.message, 'error');
                    isSpinning = false;
                    document.getElementById('spinBtn').style.opacity = 1;
                    return;
                }
                
                wheel.classList.remove('wheel-loading');
                const targetDeg = (data.targetIndex * 60) + 30; 
                const finalRotate = 1800 + (360 - targetDeg); 

                void wheel.offsetWidth; 

                wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
                wheel.style.transform = `rotate(${finalRotate}deg)`;

                setTimeout(() => {
                    updateBalanceUI(data.newBalance);
                    
                    if(data.prize === "éŠ˜è¬æƒ é¡§") {
                        Swal.fire({ title: 'çœŸå¯æƒœ...', text: 'é€™æ¬¡æ²’ä¸­çï¼Œå†æ¥å†å²ï¼', icon: 'info', confirmButtonColor: '#006633' });
                        resetWheel(targetDeg);
                    } else {
                        // === ä¿®æ”¹è™•ï¼šä¸­çåªéœ€å¡«å¯«åœ°å€ ===
                        Swal.fire({
                            title: 'ğŸ‰ æ­å–œä¸­çï¼',
                            html: `
                                <p>æ‚¨ç²å¾—äº†ï¼š<b style="font-size:1.2rem; color:#d63384">${data.prize}</b></p>
                                <p class="small text-muted mb-3">ç³»çµ±å·²å¸¶å…¥æ‚¨çš„åŸºæœ¬è³‡æ–™ï¼Œè«‹è£œå……<b>æ”¶ä»¶åœ°å€</b>ä»¥åˆ©å¯„é€ï¼š</p>
                                <input id="swal-addr" class="swal2-input" placeholder="è«‹è¼¸å…¥å®Œæ•´æ”¶ä»¶åœ°å€ (å«éƒµéå€è™Ÿ)">
                            `,
                            icon: 'success',
                            confirmButtonText: 'ç¢ºèªé€å‡º',
                            confirmButtonColor: '#006633',
                            allowOutsideClick: false,
                            preConfirm: () => {
                                const addr = document.getElementById('swal-addr').value;
                                if (!addr) {
                                    Swal.showValidationMessage('è«‹å¡«å¯«æ”¶ä»¶åœ°å€æ‰èƒ½é ˜çå–”ï¼');
                                    return false;
                                }
                                return { addr: addr };
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // åªå‚³é€åœ°å€ï¼Œå…¶ä»–è³‡æ–™å¾Œå°å·²æœ‰
                                const infoStr = `æ”¶ä»¶åœ°å€: ${result.value.addr}`;
                                submitWinnerInfo(data.prize, infoStr);
                            }
                            resetWheel(targetDeg);
                        });
                        // === ä¿®æ”¹çµæŸ ===
                    }
                }, 4000);

            })
            .catch(err => {
                wheel.classList.remove('wheel-loading');
                isSpinning = false;
                document.getElementById('spinBtn').style.opacity = 1;
                Swal.fire('éŒ¯èª¤', 'é€£ç·šå¤±æ•—', 'error');
            });
        }

        function submitWinnerInfo(prizeName, infoString) {
            Swal.fire({ title: 'è³‡æ–™å‚³é€ä¸­...', didOpen: () => { Swal.showLoading() } });
            fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'submitWinnerInfo', userId: currentUserProfile.userId, prize: prizeName, info: infoString }) })
            .then(res => res.json()).then(data => { Swal.fire({ icon: 'success', title: 'è³‡æ–™å·²é€å‡º', text: 'æˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨å®‰æ’å¯„é€ï¼', confirmButtonColor: '#006633' }); });
        }

        function resetWheel(targetDeg) {
            const wheel = document.getElementById('wheel'); isSpinning = false; document.getElementById('spinBtn').style.opacity = 1;
            setTimeout(() => { wheel.style.transition = 'none'; wheel.style.transform = `rotate(${360 - targetDeg}deg)`; setTimeout(() => { wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)'; }, 50); }, 500);
        }

        function loadStoreList() {
            const select = document.getElementById('storeSelect');
            fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'getStoreList' }) })
            .then(res => res.json()).then(data => { if(data.status === 'success') { select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡æ¬²æŸ¥è©¢ä¹‹åº—å®¶...</option>'; data.stores.forEach(store => { const option = document.createElement('option'); option.value = store.id; option.text = store.name; select.appendChild(option); }); } }).catch(console.error);
        }

        function doEarn() {
             if (!currentUserProfile || !currentUserProfile.userId) { Swal.fire({ icon: 'warning', title: 'ç³»çµ±é€£ç·šä¸­', text: 'è«‹ç¨ç­‰...', timer: 2000, showConfirmButton: false }); return; }
             if (isViewOnly) return;
             const pointsInput = document.getElementById('inputPoints'); const pinInput = document.getElementById('inputPinEarn'); const btn = document.getElementById('btnEarn');
             if (!pointsInput.value || pointsInput.value <= 0 || !pinInput.value) { Swal.fire({ icon:'warning', title:'è³‡æ–™ä¸å®Œæ•´', text:'è«‹è¼¸å…¥æ¶ˆè²»æ•¸é‡èˆ‡æ ¸éŠ·ç¢¼' }); return; }
             callApi(btn, { action: 'add', userId: currentUserProfile.userId, displayName: currentUserProfile.displayName, points: pointsInput.value, storeId: currentStoreId, pin: pinInput.value }, (data) => { pinInput.value = ""; updateBalanceUI(data.totalPoints); Swal.fire({ icon: 'success', title: 'é›†é»æˆåŠŸ', html: `<div style="font-size:1.2rem">ç²å¾— <b>${data.addedPoints}</b> é»</div>`, timer: 2000, showConfirmButton: false }); });
        }

        function switchTab(tabName) {
            ['earn', 'redeem', 'game', 'history'].forEach(t => { document.getElementById('tab-' + t).classList.remove('active'); document.getElementById('page-' + t).classList.add('d-none'); });
            document.getElementById('tab-' + tabName).classList.add('active'); document.getElementById('page-' + tabName).classList.remove('d-none');
            if (tabName === 'redeem') loadRewards(); if (tabName === 'history') loadHistory();
        }
        
        function loadRewards() {
             if (!currentUserProfile) return; const listDiv = document.getElementById('rewardList'); let targetStoreId = currentStoreId;
             if (isViewOnly) { const selectVal = document.getElementById('storeSelect').value; if (selectVal) targetStoreId = selectVal; else targetStoreId = 'store00'; }
             listDiv.innerHTML = '<div class="text-center w-100 py-4" style="grid-column: span 2;"><div class="spinner-border text-success" role="status"></div><div class="small text-muted mt-2">æ›´æ–°åº«å­˜è³‡è¨Š...</div></div>';
             fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'getRewards', userId: currentUserProfile.userId, storeId: targetStoreId }) })
             .then(res => res.json()).then(data => {
                 listDiv.innerHTML = ""; if(data.userBalance !== undefined) updateBalanceUI(data.userBalance);
                 if (isViewOnly && targetStoreId === 'store00') listDiv.insertAdjacentHTML('beforeend', "<p class='text-center mt-2 text-muted' style='grid-column: span 2;'><i class='fas fa-arrow-up'></i> è«‹é¸æ“‡ä¸Šæ–¹åº—å®¶ä»¥æŸ¥çœ‹åº«å­˜</p>");
                 if (!data.rewards || data.rewards.length === 0) { listDiv.innerHTML = "<p class='text-center w-100 mt-5 text-muted' style='grid-column: span 2;'>ç›®å‰ç„¡å¯å…Œæ›å•†å“</p>"; return; }
                 data.rewards.forEach(item => {
                     const isOutOfStock = item.stock <= 0; const imgUrl = item.image && item.image.startsWith('http') ? item.image : "https://via.placeholder.com/300x200?text=Taiwan+Beer";
                     let btnHtml = isViewOnly ? `<button class="btn btn-secondary btn-redeem" disabled>è«‹è‡³é–€å¸‚å…Œæ›</button>` : (isOutOfStock ? `<button class="btn btn-secondary btn-redeem" disabled>å·²å…Œå®Œ</button>` : `<button class="btn btn-outline-success btn-redeem" onclick="askRedeem('${item.name}', ${item.cost})">å…Œæ›</button>`);
                     let stockText = (targetStoreId === 'store00') ? "è«‹é¸åº—" : `å‰© ${item.stock}`; let stockClass = (targetStoreId !== 'store00' && isOutOfStock) ? "out" : "";
                     const html = `<div class="reward-card"><img src="${imgUrl}" class="reward-img" alt="${item.name}"><div class="reward-body"><div><div class="reward-title">${item.name}</div><div class="reward-meta"><span class="text-warning fw-bold"><i class="fas fa-gem"></i> ${item.cost}</span><span class="stock-badge ${stockClass}">${stockText}</span></div></div>${btnHtml}</div></div>`;
                     listDiv.insertAdjacentHTML('beforeend', html);
                 });
             }).catch(err => { listDiv.innerHTML = "<p class='text-danger text-center w-100' style='grid-column: span 2;'>è¼‰å…¥å¤±æ•—</p>"; });
        }

        function loadHistory() {
             if (!currentUserProfile) return; const listDiv = document.getElementById('historyList');
             listDiv.innerHTML = `<div class="text-center w-100 py-4"><div class="spinner-border text-success" role="status"></div></div>`;
             fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'getHistory', userId: currentUserProfile.userId }) })
             .then(res => res.json()).then(data => {
                 listDiv.innerHTML = ""; if (!data.history || data.history.length === 0) { listDiv.innerHTML = "<p class='text-center w-100 mt-5 text-muted'>å°šç„¡äº¤æ˜“ç´€éŒ„</p>"; return; }
                 data.history.forEach(item => { const isPositive = item.points > 0; const pointClass = isPositive ? 'points-add' : 'points-minus'; const pointSign = isPositive ? '+' : ''; const html = `<div class="history-item"><div class="history-info"><div class="history-action">${item.action}</div><div class="history-meta"><span class="me-2"><i class="far fa-clock"></i> ${item.date}</span><span><i class="fas fa-store"></i> ${item.store}</span></div></div><div class="history-points ${pointClass}">${pointSign}${item.points}</div></div>`; listDiv.insertAdjacentHTML('beforeend', html); });
             }).catch(err => { listDiv.innerHTML = "<p class='text-danger text-center w-100'>è¼‰å…¥å¤±æ•—</p>"; });
        }

        function askRedeem(rewardName, cost) {
             Swal.fire({ title: 'å…Œæ›ç¢ºèª', html: `å•†å“ï¼š<b>${rewardName}</b><br>æ‰£é™¤ï¼š<b class="text-danger">${cost}</b> é»<br><br><small>è«‹åº—å“¡è¼¸å…¥æ ¸éŠ·ç¢¼</small>`, input: 'password', inputAttributes: { maxlength: 4, placeholder: 'PIN Code' }, showCancelButton: true, confirmButtonText: 'ç¢ºå®šå…Œæ›', confirmButtonColor: '#006633', cancelButtonText: 'å–æ¶ˆ', reverseButtons: true
             }).then((result) => { if (result.isConfirmed) { if (!result.value) { Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥æ ¸éŠ·ç¢¼', 'error'); return; } callApi(null, { action: 'redeem', userId: currentUserProfile.userId, displayName: currentUserProfile.displayName, storeId: currentStoreId, pin: result.value, rewardName: rewardName, cost: cost }, (data) => { updateBalanceUI(data.totalPoints); loadRewards(); Swal.fire({ icon: 'success', title: 'å…Œæ›æˆåŠŸ', html: `æ‚¨å·²å…Œæ› <b>${data.redeemedItem}</b>`, }); }); } });
        }

        function callApi(btnElement, payload, successCallback) {
             if (btnElement) { btnElement.disabled = true; btnElement.innerText = "è™•ç†ä¸­..."; } Swal.showLoading();
             fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) })
             .then(res => res.json()).then(data => { if (btnElement) { btnElement.disabled = false; btnElement.innerText = "ç¢ºèªé›†é»"; } Swal.close(); if (data.status === 'success') successCallback(data); else Swal.fire({ icon:'error', title:'ç„¡æ³•åŸ·è¡Œ', text: data.message });
             }).catch(err => { if (btnElement) btnElement.disabled = false; Swal.fire('éŒ¯èª¤', 'ç¶²è·¯é€£ç·šç•°å¸¸', 'error'); });
        }

        function updateBalanceUI(points) { const el = document.getElementById('headerPoints'); el.innerText = points; el.classList.add('fade-in'); setTimeout(() => el.classList.remove('fade-in'), 500); }
    </script>
</body>
</html>