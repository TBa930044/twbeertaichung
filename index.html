<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†é»æ ¸éŠ·</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-confirm { background-color: #06c755; color: white; width: 100%; padding: 12px; font-weight: bold; }
        .store-tag { background: #e9ecef; padding: 5px 10px; border-radius: 20px; font-size: 12px; color: #555; }
    </style>
</head>
<body>

    <div class="card p-4 text-center">
        <h4 class="mb-2">ğŸº ç¾å ´é›†é»</h4>
        <div class="mb-4"><span id="storeDisplay" class="store-tag">è®€å–åº—å®¶è³‡è¨Šä¸­...</span></div>

        <div class="mb-3 text-start">
            <label class="form-label">è¼¸å…¥é»æ•¸ (æ¶ˆè²»ç“¶æ•¸)</label>
            <input type="number" id="inputPoints" class="form-control form-control-lg text-center" value="1" min="1">
        </div>

        <div class="mb-4 text-start">
            <label class="form-label text-danger">åº—å“¡æ ¸éŠ·ç¢¼ (è«‹äº¤çµ¦åº—å“¡)</label>
            <input type="password" id="inputPin" class="form-control form-control-lg text-center" placeholder="****" maxlength="4">
        </div>

        <button id="btnSubmit" class="btn btn-confirm btn-lg" onclick="verifyAndSend()">ç¢ºèªæ ¸éŠ·</button>
        
        <p id="status" class="mt-3 text-secondary" style="font-size:14px;"></p>
    </div>

    <script>
        // ================= è¨­å®šå€ =================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYI4M2RuswYcxoMy98Gr8WLinypnvZwrYAwtHsD84rX0unB26FKKx4u0dcuB9Ojo62/exec"; // â˜…è¨˜å¾—å¡«å›æ‚¨çš„ GAS ç¶²å€
        const MY_LIFF_ID = "2008765350-4KBTGWMz"; 
        // ==========================================

        // è®€å–ç¶²å€åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const currentStoreId = urlParams.get('store') || 'store01'; // é è¨­å€¼

        // åˆå§‹åŒ–
        function initializeLiff() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                // é¡¯ç¤ºåº—å®¶ä»£ç¢¼åœ¨ç•«é¢ä¸Š
                document.getElementById('storeDisplay').innerText = "åº—å®¶ä»£ç¢¼: " + currentStoreId;
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            });
        }

        // æ ¸å¿ƒåŠŸèƒ½ï¼šé©—è­‰ä¸¦é€å‡º
function verifyAndSend() {
            const points = document.getElementById('inputPoints').value;
            const pin = document.getElementById('inputPin').value;
            const btn = document.getElementById('btnSubmit');

            if (!points || points <= 0) { Swal.fire('å“å‘€ï¼', 'è«‹è¼¸å…¥æ­£ç¢ºçš„é»æ•¸', 'warning'); return; }
            if (!pin) { Swal.fire('å“å‘€ï¼', 'è«‹è¼¸å…¥åº—å“¡æ ¸éŠ·ç¢¼', 'warning'); return; }

            btn.disabled = true;
            btn.innerText = "é©—è­‰ä¸­...";

            liff.getProfile().then(profile => {
                const payload = {
                    userId: profile.userId,
                    points: points,
                    storeId: currentStoreId,
                    pin: pin
                };

                // â˜… ä¿®æ”¹é»ï¼šç§»é™¤ no-corsï¼Œæ”¹ç‚ºè®€å– JSON å›æ‡‰
                fetch(GAS_API_URL, {
                    method: "POST",
                    // ä½¿ç”¨ text/plain é¿å…è§¸ç™¼ç€è¦½å™¨å° GAS çš„ CORS é æª¢ (Options Request)
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json()) // è§£æå¾Œç«¯å›å‚³çš„ JSON
                .then(data => {
                    // â˜… æ ¹æ“šå¾Œç«¯å›å‚³çš„ status åˆ¤æ–·
                    if (data.status === 'success') {
                        // === æˆåŠŸæƒ…å¢ƒ ===
                        Swal.fire({
                            title: 'é›†é»æˆåŠŸï¼',
                            // é€™è£¡é¡¯ç¤ºï¼šç²å¾—é»æ•¸ + ç›®å‰ç¸½é»æ•¸
                            html: `æœ¬æ¬¡ç²å¾— <b>${data.addedPoints}</b> é»<br>æ‚¨çš„ç›®å‰ç¸½é»æ•¸ï¼š<span style="color:red;font-size:1.5em">${data.totalPoints}</span>`,
                            icon: 'success',
                            confirmButtonText: 'å¤ªæ£’äº†',
                            timer: 4000
                        }).then(() => {
                            liff.closeWindow(); // 4ç§’å¾Œè‡ªå‹•é—œé–‰
                        });
                    } else {
                        // === å¤±æ•—æƒ…å¢ƒ (å¯†ç¢¼éŒ¯èª¤) ===
                        Swal.fire({
                            title: 'æ ¸éŠ·å¤±æ•—',
                            text: 'åº—å“¡æ ¸éŠ·ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥',
                            icon: 'error',
                            confirmButtonText: 'é‡è©¦'
                        });
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ï¼Œè®“åº—å“¡å¯ä»¥é‡æ‰“
                        btn.disabled = false;
                        btn.innerText = "ç¢ºèªæ ¸éŠ·";
                        // æ¸…ç©ºå¯†ç¢¼æ¬„
                        document.getElementById('inputPin').value = "";
                    }
                })
                .catch(err => {
                    Swal.fire('ç³»çµ±éŒ¯èª¤', 'é€£ç·šå¤±æ•—æˆ–æ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'error');
                    console.error(err);
                    btn.disabled = false;
                    btn.innerText = "ç¢ºèªæ ¸éŠ·";
                });
            }).catch(err => {
                Swal.fire('éŒ¯èª¤', 'ç„¡æ³•å–å¾— LINE è³‡æ–™', 'error');
            });
        }
        // å•Ÿå‹• LIFF
        window.onload = initializeLiff;
    </script>
</body>
</html>