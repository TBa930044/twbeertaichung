<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TTL 會員專區</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-color: #006633; --accent-color: #FFC107; --bg-color: #f4f6f8; }
        body { background-color: var(--bg-color); font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 80px; }
        
        .header-section {
            background: linear-gradient(135deg, #004d26 0%, #008040 100%); color: white; padding: 25px 20px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,80,0,0.25); position: relative; overflow: hidden;
        }
        .header-bg-circle {
            position: absolute; top: -30px; right: -30px; width: 180px; height: 180px;
            background: rgba(255,255,255,0.08); border-radius: 50%;
        }
        .user-greeting { font-size: 0.95rem; opacity: 0.9; margin-bottom: 5px; }
        .store-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; backdrop-filter: blur(4px); }
        .balance-card { margin-top: 20px; text-align: center; }
        .balance-number { font-size: 3.8rem; font-weight: 800; color: var(--accent-color); text-shadow: 0 2px 5px rgba(0,0,0,0.2); line-height: 1; }
        .balance-label { font-size: 0.9rem; opacity: 0.8; letter-spacing: 1px; }

        .custom-card { background: white; border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 15px; padding: 25px 20px; }
        .history-list { display: flex; flex-direction: column; gap: 10px; }
        .history-item { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .history-info { flex: 1; }
        .history-action { font-weight: bold; color: #333; margin-bottom: 2px; }
        .history-meta { font-size: 0.8rem; color: #888; }
        .history-points { font-size: 1.2rem; font-weight: bold; }
        .points-add { color: var(--primary-color); }
        .points-minus { color: #dc3545; }

        .reward-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .reward-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; transition: transform 0.2s; }
        .reward-card:active { transform: scale(0.98); }
        .reward-img { width: 100%; height: 140px; object-fit: cover; background-color: #f0f0f0; }
        .reward-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .reward-title { font-size: 0.95rem; font-weight: bold; color: #333; margin-bottom: 5px; line-height: 1.3; height: 2.6em; overflow: hidden; }
        .reward-meta { font-size: 0.8rem; color: #666; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .stock-badge { color: var(--primary-color); font-weight: 500;}
        .stock-badge.out { color: #dc3545; }
        
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: white; border-radius: 50px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); display: flex; padding: 5px; z-index: 999; }
        .nav-btn { flex: 1; text-align: center; padding: 12px 0; border-radius: 40px; color: #aaa; font-weight: bold; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.9rem; }
        .nav-btn.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(0,102,51,0.3); }

        .form-control-custom { border: 2px solid #eee; border-radius: 12px; padding: 14px; font-size: 1.1rem; text-align: center; background-color: #fafafa; }
        .form-control-custom:focus { border-color: var(--primary-color); background-color: #fff; box-shadow: 0 0 0 3px rgba(0,102,51,0.1); }
        .btn-action { width: 100%; background: var(--primary-color); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; font-size: 1.1rem; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,102,51,0.3); transition: background-color 0.3s; }
        .btn-action:active { transform: scale(0.98); box-shadow: none;}
        .btn-action:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }
        .btn-redeem { width: 100%; padding: 6px; font-size: 0.9rem; border-radius: 8px; }

        .d-none { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 黃色除錯框 (Debug Box) - 顯示在最上層 */
        #debugConsole {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(255, 235, 59, 0.95);
            color: #000; font-size: 10px; padding: 5px; z-index: 9999;
            max-height: 100px; overflow-y: auto; border-bottom: 2px solid #fbc02d;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <div id="debugConsole">系統初始化中...</div>

    <div class="header-section">
        <div class="header-bg-circle"></div>
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="user-greeting" id="userGreeting">Hi, 會員</div>
                <div style="font-weight:bold; font-size:1.2rem;">
                    <i class="fas fa-beer"></i> 台灣啤酒
                </div>
            </div>
            <div class="store-badge" id="storeDisplay">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
        <div class="balance-card">
            <div class="balance-number" id="headerPoints">...</div>
            <div class="balance-label">目前持有點數</div>
        </div>
    </div>

    <div class="container mt-3">
        <div id="page-earn" class="fade-in">
            <div class="custom-card">
                <h5 class="fw-bold mb-4" style="color:#333;"><i class="fas fa-qrcode me-2 text-success"></i>掃碼集點</h5>
                <div class="mb-3">
                    <label class="text-muted small mb-2 fw-bold">消費瓶數 / 金額</label>
                    <input type="number" id="inputPoints" class="form-control form-control-custom" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label class="text-muted small mb-2 fw-bold">請店員輸入核銷碼</label>
                    <input type="password" id="inputPinEarn" class="form-control form-control-custom" placeholder="PIN Code" maxlength="4">
                </div>
                <button id="btnEarn" class="btn-action" onclick="doEarn()" disabled>連線中...</button>
            </div>
            <div class="custom-card py-3 text-center" style="background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;">
                <small><i class="fas fa-info-circle me-1"></i> 請向店員出示本畫面進行集點</small>
            </div>
        </div>

        <div id="page-redeem" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;好禮兌換專區</h5>
            <div id="rewardList" class="reward-grid">
                <div class="text-center w-100 py-4"><div class="spinner-border text-success" role="status"></div></div>
            </div>
            <div style="height: 100px;"></div> 
        </div>

        <div id="page-history" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;近期交易紀錄</h5>
            <div id="historyList" class="history-list">
                <div class="text-center w-100 py-4"><div class="spinner-border text-success" role="status"></div></div>
            </div>
            <div style="height: 100px;"></div> 
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" id="tab-earn" onclick="switchTab('earn')"><i class="fas fa-camera"></i> 集點</div>
        <div class="nav-btn" id="tab-redeem" onclick="switchTab('redeem')"><i class="fas fa-gift"></i> 兌換</div>
        <div class="nav-btn" id="tab-history" onclick="switchTab('history')"><i class="fas fa-history"></i> 紀錄</div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYI4M2RuswYcxoMy98Gr8WLinypnvZwrYAwtHsD84rX0unB26FKKx4u0dcuB9Ojo62/exec"; 
        const MY_LIFF_ID = "2008765350-4KBTGWMz"; 
        
        // --- 1. 超級參數抓取邏輯 (Local Storage 救援) ---
        function log(msg) {
            console.log(msg);
            document.getElementById('debugConsole').innerHTML = msg + "<br>" + document.getElementById('debugConsole').innerHTML;
        }

        const urlParams = new URLSearchParams(window.location.search);
        let storeParam = urlParams.get('store');
        
        // 如果 URL 沒參數，嘗試從 hash 抓
        if (!storeParam && window.location.hash) {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            storeParam = hashParams.get('store');
        }

        // **關鍵修正**: 
        // 1. 如果 URL 有參數，趕快存到 LocalStorage (手機記憶體)
        // 2. 如果 URL 沒參數 (被 LINE 吃掉了)，趕快去 LocalStorage 找回來
        if (storeParam) {
            localStorage.setItem('savedStoreId', storeParam);
            log("參數已儲存: " + storeParam);
        } else {
            const saved = localStorage.getItem('savedStoreId');
            if (saved) {
                storeParam = saved;
                log("參數遺失，從記憶體救援成功: " + saved);
            } else {
                log("無參數且無記憶，使用預設值");
            }
        }

        const currentStoreId = storeParam || 'store01'; 
        let currentUserProfile = null;
        const isViewOnly = (currentStoreId === 'store00');

        window.onload = function() {
            log("頁面載入... 店家: " + currentStoreId);
            document.getElementById('headerPoints').innerText = "載入中..."; 
            document.getElementById('headerPoints').style.fontSize = "1.5rem";

            // 設定 UI
            if (isViewOnly) {
                document.getElementById('storeDisplay').innerHTML = `<i class="fas fa-search me-1"></i> 集點查詢`;
                document.getElementById('inputPoints').disabled = true;
                document.getElementById('inputPoints').placeholder = "僅供查詢";
                document.getElementById('inputPinEarn').disabled = true;
                document.getElementById('inputPinEarn').placeholder = "請至門市集點";
                const btn = document.getElementById('btnEarn');
                btn.disabled = true;
                btn.innerText = "此模式僅供查詢餘額";
            } else {
                document.getElementById('storeDisplay').innerHTML = `<i class="fas fa-map-marker-alt me-1"></i> ${currentStoreId}`;
            }

            // 初始化 LIFF
            log("開始 LIFF Init...");
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                log("LIFF Init 完成");
                
                if (!liff.isLoggedIn()) {
                    log("未登入，跳轉登入中...");
                    // 登入前，確保目前的 URL 包含參數，這樣回來時才不會掉
                    // 如果目前網址沒有參數，我們手動補上去再跳轉
                    let loginRedirect = window.location.href;
                    if(currentStoreId && !window.location.search.includes('store')) {
                         // 簡單判斷，如果原本沒參數就補 ?store=...
                         loginRedirect = loginRedirect.split('?')[0] + '?store=' + currentStoreId;
                    }
                    liff.login({ redirectUri: loginRedirect });
                } else {
                    log("已登入，取得資料中...");
                    liff.getProfile().then(profile => { 
                        currentUserProfile = profile;
                        log("取得 User ID: " + profile.userId.substring(0, 5) + "...");
                        
                        if(profile.displayName) {
                            document.getElementById('userGreeting').innerText = `Hi, ${profile.displayName}`;
                        }
                        
                        // 解鎖按鈕
                        if(!isViewOnly) {
                            const btn = document.getElementById('btnEarn');
                            btn.disabled = false;
                            btn.innerText = "確認集點";
                        }

                        checkBalanceImmediately(profile.userId);
                    }).catch(err => {
                        log("Profile 錯誤: " + err);
                        Swal.fire('錯誤', '無法取得使用者資料，請重新整理', 'error');
                    });
                }
            }).catch(err => {
                log("LIFF Init 失敗: " + err);
                document.getElementById('headerPoints').innerText = "Err";
            });
        };

        function doEarn() {
            // 防呆檢查
            if (!currentUserProfile || !currentUserProfile.userId) {
                log("按鈕觸發但無 User 資料");
                Swal.fire({
                    icon: 'warning',
                    title: '系統連線中',
                    text: '請稍等，正在讀取您的會員資料...',
                    timer: 2000,
                    showConfirmButton: false
                });
                return;
            }

            if (isViewOnly) return;

            const pointsInput = document.getElementById('inputPoints');
            const pinInput = document.getElementById('inputPinEarn');
            const btn = document.getElementById('btnEarn');
            
            if (!pointsInput.value || pointsInput.value <= 0 || !pinInput.value) {
                Swal.fire({ icon:'warning', title:'資料不完整', text:'請輸入消費數量與核銷碼' });
                return;
            }

            log("送出集點請求...");
            callApi(btn, {
                action: 'add',
                userId: currentUserProfile.userId,
                displayName: currentUserProfile.displayName, 
                points: pointsInput.value,
                storeId: currentStoreId, // 這裡會送出從 LocalStorage 救援回來的 ID
                pin: pinInput.value
            }, (data) => {
                log("集點成功");
                pinInput.value = ""; 
                updateBalanceUI(data.totalPoints); 
                Swal.fire({
                    icon: 'success',
                    title: '集點成功',
                    html: `<div style="font-size:1.2rem">獲得 <b>${data.addedPoints}</b> 點</div>`,
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        }

        // --- 其他函式不變 ---
        function checkBalanceImmediately(userId) {
            log("查詢餘額...");
            fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'checkBalance', userId: userId }) })
            .then(res => res.json()).then(data => {
                log("餘額: " + data.userBalance);
                document.getElementById('headerPoints').style.fontSize = "3.8rem";
                if(data.userBalance !== undefined) updateBalanceUI(data.userBalance);
            }).catch(err => { log("查餘額失敗"); document.getElementById('headerPoints').innerText = "---"; });
        }

        function switchTab(tabName) {
            ['earn', 'redeem', 'history'].forEach(t => {
                document.getElementById('tab-' + t).classList.remove('active');
                document.getElementById('page-' + t).classList.add('d-none');
            });
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('page-' + tabName).classList.remove('d-none');
            if (tabName === 'redeem') loadRewards();
            if (tabName === 'history') loadHistory();
        }
        
        function loadRewards() {
            if (!currentUserProfile) return;
            const listDiv = document.getElementById('rewardList');
            fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'getRewards', userId: currentUserProfile.userId, storeId: currentStoreId }) })
            .then(res => res.json()).then(data => {
                listDiv.innerHTML = ""; 
                if(data.userBalance !== undefined) updateBalanceUI(data.userBalance);
                if (!data.rewards || data.rewards.length === 0) { listDiv.innerHTML = "<p class='text-center w-100 mt-5 text-muted'>目前無可兌換商品</p>"; return; }
                data.rewards.forEach(item => {
                    const isOutOfStock = item.stock <= 0;
                    const imgUrl = item.image && item.image.startsWith('http') ? item.image : "https://via.placeholder.com/300x200?text=Taiwan+Beer";
                    let btnHtml = isViewOnly ? `<button class="btn btn-secondary btn-redeem" disabled>請至門市兌換</button>` : (isOutOfStock ? `<button class="btn btn-secondary btn-redeem" disabled>已兌完</button>` : `<button class="btn btn-outline-success btn-redeem" onclick="askRedeem('${item.name}', ${item.cost})">兌換</button>`);
                    const stockHtml = isOutOfStock ? `<span class="stock-badge out"><i class="fas fa-times-circle"></i> 缺貨</span>` : `<span class="stock-badge"><i class="fas fa-check-circle"></i> 剩 ${item.stock}</span>`;
                    const html = `<div class="reward-card"><img src="${imgUrl}" class="reward-img" alt="${item.name}"><div class="reward-body"><div><div class="reward-title">${item.name}</div><div class="reward-meta"><span class="text-warning fw-bold"><i class="fas fa-gem"></i> ${item.cost}</span>${stockHtml}</div></div>${btnHtml}</div></div>`;
                    listDiv.insertAdjacentHTML('beforeend', html);
                });
            }).catch(err => { listDiv.innerHTML = "<p class='text-danger text-center w-100'>載入失敗</p>"; });
        }

        function loadHistory() {
            if (!currentUserProfile) return;
            const listDiv = document.getElementById('historyList');
            listDiv.innerHTML = `<div class="text-center w-100 py-4"><div class="spinner-border text-success" role="status"></div></div>`;
            fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'getHistory', userId: currentUserProfile.userId }) })
            .then(res => res.json()).then(data => {
                listDiv.innerHTML = ""; 
                if (!data.history || data.history.length === 0) { listDiv.innerHTML = "<p class='text-center w-100 mt-5 text-muted'>尚無交易紀錄</p>"; return; }
                data.history.forEach(item => {
                    const isPositive = item.points > 0;
                    const pointClass = isPositive ? 'points-add' : 'points-minus';
                    const pointSign = isPositive ? '+' : '';
                    const html = `<div class="history-item"><div class="history-info"><div class="history-action">${item.action}</div><div class="history-meta"><span class="me-2"><i class="far fa-clock"></i> ${item.date}</span><span><i class="fas fa-store"></i> ${item.store}</span></div></div><div class="history-points ${pointClass}">${pointSign}${item.points}</div></div>`;
                    listDiv.insertAdjacentHTML('beforeend', html);
                });
            }).catch(err => { listDiv.innerHTML = "<p class='text-danger text-center w-100'>載入失敗</p>"; });
        }

        function askRedeem(rewardName, cost) {
            Swal.fire({
                title: '兌換確認', html: `商品：<b>${rewardName}</b><br>扣除：<b class="text-danger">${cost}</b> 點<br><br><small>請店員輸入核銷碼</small>`,
                input: 'password', inputAttributes: { maxlength: 4, placeholder: 'PIN Code' },
                showCancelButton: true, confirmButtonText: '確定兌換', confirmButtonColor: '#006633', cancelButtonText: '取消', reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    if (!result.value) { Swal.fire('錯誤', '請輸入核銷碼', 'error'); return; }
                    callApi(null, { action: 'redeem', userId: currentUserProfile.userId, displayName: currentUserProfile.displayName, storeId: currentStoreId, pin: result.value, rewardName: rewardName, cost: cost }, (data) => {
                        updateBalanceUI(data.totalPoints); loadRewards(); Swal.fire({ icon: 'success', title: '兌換成功', html: `您已兌換 <b>${data.redeemedItem}</b>`, });
                    });
                }
            });
        }

        function callApi(btnElement, payload, successCallback) {
            if (btnElement) { btnElement.disabled = true; btnElement.innerText = "處理中..."; }
            Swal.showLoading();
            fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) })
            .then(res => res.json()).then(data => {
                if (btnElement) { btnElement.disabled = false; btnElement.innerText = "確認集點"; }
                Swal.close();
                if (data.status === 'success') successCallback(data);
                else Swal.fire({ icon:'error', title:'無法執行', text: data.message });
            }).catch(err => {
                if (btnElement) btnElement.disabled = false; Swal.fire('錯誤', '網路連線異常', 'error');
            });
        }

        function updateBalanceUI(points) {
            const el = document.getElementById('headerPoints');
            el.innerText = points;
            el.classList.add('fade-in');
            setTimeout(() => el.classList.remove('fade-in'), 500);
        }
    </script>
</body>
</html>