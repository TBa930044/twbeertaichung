<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†é»æ ¸éŠ·</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-confirm { background-color: #06c755; color: white; width: 100%; padding: 12px; font-weight: bold; }
        .store-tag { background: #e9ecef; padding: 5px 10px; border-radius: 20px; font-size: 12px; color: #555; }
    </style>
</head>
<body>

    <div class="card p-4 text-center">
        <h4 class="mb-2">ğŸº ç¾å ´é›†é»</h4>
        <div class="mb-4"><span id="storeDisplay" class="store-tag">è®€å–åº—å®¶è³‡è¨Šä¸­...</span></div>

        <div class="mb-3 text-start">
            <label class="form-label">è¼¸å…¥é»æ•¸ (æ¶ˆè²»ç“¶æ•¸)</label>
            <input type="number" id="inputPoints" class="form-control form-control-lg text-center" value="1" min="1">
        </div>

        <div class="mb-4 text-start">
            <label class="form-label text-danger">åº—å“¡æ ¸éŠ·ç¢¼ (è«‹äº¤çµ¦åº—å“¡)</label>
            <input type="password" id="inputPin" class="form-control form-control-lg text-center" placeholder="****" maxlength="4">
        </div>

        <button id="btnSubmit" class="btn btn-confirm btn-lg" onclick="verifyAndSend()">ç¢ºèªæ ¸éŠ·</button>
        
        <p id="status" class="mt-3 text-secondary" style="font-size:14px;"></p>
    </div>

    <script>
        // ================= è¨­å®šå€ =================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYI4M2RuswYcxoMy98Gr8WLinypnvZwrYAwtHsD84rX0unB26FKKx4u0dcuB9Ojo62/exec"; 
        const MY_LIFF_ID = "2008765350-4KBTGWMz"; 
        // ==========================================

        // å¾ç¶²å€è®€å– StoreID (ä¾‹å¦‚ ?store=store01)
        const urlParams = new URLSearchParams(window.location.search);
        // å¦‚æœç¶²å€æ²’å¸¶åƒæ•¸ï¼Œé è¨­ç‚º store01 (æ¸¬è©¦ç”¨)
        const currentStoreId = urlParams.get('store') || 'store01';

        document.getElementById('storeDisplay').innerText = "åº—å®¶ä»£ç¢¼: " + currentStoreId;

        function initializeLiff() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) { liff.login(); }
            });
        }

        function verifyAndSend() {
            const points = document.getElementById('inputPoints').value;
            const pin = document.getElementById('inputPin').value;
            const status = document.getElementById('status');
            const btn = document.getElementById('btnSubmit');

            if (!pin) { alert("è«‹è¼¸å…¥åº—å“¡æ ¸éŠ·ç¢¼"); return; }

            btn.disabled = true;
            btn.innerText = "é©—è­‰ä¸­...";
            status.innerText = "";

            liff.getProfile().then(profile => {
                const payload = {
                    userId: profile.userId,
                    points: points,
                    storeId: currentStoreId,
                    pin: pin
                };

                fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                }).then(() => {
                    // å› ç‚º no-cors çœ‹ä¸åˆ°å›å‚³çµæœï¼Œæˆ‘å€‘åªèƒ½å‡è¨­è«‹æ±‚ç™¼é€æˆåŠŸ
                    // ç‚ºäº†ä½¿ç”¨è€…é«”é©—ï¼Œé€™è£¡åšä¸€å€‹ç°¡å–®çš„æ¨¡æ“¬æˆåŠŸ UI
                    status.innerText = "âœ… è«‹æ±‚å·²ç™¼é€ï¼è‹¥å¯†ç¢¼æ­£ç¢ºé»æ•¸å°‡å…¥å¸³";
                    status.style.color = "green";
                    
                    // æ¸…ç©ºå¯†ç¢¼æ¬„ä½é˜²æ­¢é‡è¤‡æŒ‰
                    document.getElementById('inputPin').value = "";
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerText = "ç¢ºèªæ ¸éŠ·";
                        liff.closeWindow(); // æˆåŠŸå¾Œé—œé–‰è¦–çª—
                    }, 2000);
                });
            });
        }

        window.onload = initializeLiff;
    </script>
</body>
</html>