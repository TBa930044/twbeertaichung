<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TTL 會員專區</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #006633; /* 台啤深綠 */
            --accent-color: #FFC107;  /* 金牌黃 */
            --bg-color: #f4f6f8;
        }
        body { background-color: var(--bg-color); font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 80px; }
        
        /* 1. 頂部會員卡區塊 */
        .header-section {
            background: linear-gradient(135deg, #004d26 0%, #008040 100%);
            color: white;
            padding: 20px;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,80,0,0.2);
            position: relative;
            overflow: hidden;
        }
        /* 裝飾用的背景圓圈 */
        .header-bg-circle {
            position: absolute;
            top: -20px; right: -20px;
            width: 150px; height: 150px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .store-badge {
            background: rgba(0,0,0,0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
        }
        .balance-card {
            margin-top: 15px;
            text-align: center;
        }
        .balance-number {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--accent-color);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            line-height: 1.1;
        }
        .balance-label { font-size: 0.9rem; opacity: 0.9; }

        /* 2. 卡片通用樣式 */
        .custom-card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            padding: 20px;
        }
        
        /* 3. 贈品網格排版 */
        .reward-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 兩欄 */
            gap: 15px;
        }
        .reward-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }
        .reward-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background-color: #eee;
        }
        .reward-body {
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .reward-title {
            font-size: 0.95rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            line-height: 1.3;
        }
        .reward-meta {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        .stock-badge { color: var(--primary-color); }
        .stock-badge.out { color: #dc3545; }
        
        /* 4. 底部導覽列 (Sticky Bottom) */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background: white;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex;
            padding: 5px;
            z-index: 999;
        }
        .nav-btn {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            border-radius: 40px;
            color: #999;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 10px rgba(0,102,51,0.3);
        }
        .nav-btn i { margin-right: 5px; }

        /* 輸入框美化 */
        .form-control-custom {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 12px;
            font-size: 1.1rem;
            text-align: center;
        }
        .form-control-custom:focus {
            border-color: var(--primary-color);
            box-shadow: none;
        }
        .btn-action {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 15px;
        }
        .btn-action:active { transform: scale(0.98); }
        .btn-redeem {
            width: 100%;
            padding: 6px;
            font-size: 0.9rem;
            border-radius: 6px;
        }

        /* 隱藏區塊 */
        .d-none { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="header-bg-circle"></div>
        <div class="d-flex justify-content-between align-items-center">
            <div style="font-weight:bold; font-size:1.1rem;">
                <i class="fas fa-beer"></i> 台灣啤酒
            </div>
            <div class="store-badge" id="storeDisplay">
                <i class="fas fa-map-marker-alt me-1"></i> 載入中...
            </div>
        </div>

        <div class="balance-card">
            <div class="balance-number" id="headerPoints">---</div>
            <div class="balance-label">目前持有點數 (Points)</div>
        </div>
    </div>

    <div class="container mt-3">
        
        <div id="page-earn" class="fade-in">
            <div class="custom-card">
                <h5 class="fw-bold mb-4" style="color:#333;"><i class="fas fa-plus-circle me-2 text-success"></i>掃碼集點</h5>
                
                <div class="mb-3">
                    <label class="text-muted small mb-1">消費瓶數 / 金額</label>
                    <input type="number" id="inputPoints" class="form-control form-control-custom" value="1" min="1">
                </div>

                <div class="mb-3">
                    <label class="text-muted small mb-1">請店員輸入核銷碼</label>
                    <input type="password" id="inputPinEarn" class="form-control form-control-custom" placeholder="PIN Code" maxlength="4">
                </div>

                <button id="btnEarn" class="btn-action" onclick="doEarn()">確認集點</button>
            </div>
            
            <div class="custom-card py-3 text-center" style="background:#e8f5e9; color:#2e7d32;">
                <small><i class="fas fa-bullhorn me-1"></i> 週末限定：購買18天生啤點數加倍！</small>
            </div>
        </div>

        <div id="page-redeem" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;好禮兌換專區</h5>
            
            <div id="rewardList" class="reward-grid">
                <div class="text-center w-100 py-4" style="grid-column: span 2;">
                    <div class="spinner-border text-success" role="status"></div>
                    <div class="mt-2 text-muted small">檢查庫存中...</div>
                </div>
            </div>
            
            <div style="height: 100px;"></div> </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" id="tab-earn" onclick="switchTab('earn')">
            <i class="fas fa-qrcode"></i> 集點
        </div>
        <div class="nav-btn" id="tab-redeem" onclick="switchTab('redeem')">
            <i class="fas fa-gift"></i> 兌換
        </div>
    </div>

    <script>
        // ================= 設定區 =================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYI4M2RuswYcxoMy98Gr8WLinypnvZwrYAwtHsD84rX0unB26FKKx4u0dcuB9Ojo62/exec"; 
        const MY_LIFF_ID = "2008765350-4KBTGWMz"; 
        // ==========================================

        const urlParams = new URLSearchParams(window.location.search);
        const currentStoreId = urlParams.get('store') || 'store01'; 
        let currentUserProfile = null;

        // 初始化
        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                document.getElementById('storeDisplay').innerHTML = `<i class="fas fa-store me-1"></i> ${currentStoreId}`;
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    liff.getProfile().then(profile => { 
                        currentUserProfile = profile;
                        // 初始先讀取一次點數 (偷偷呼叫 getRewards 雖然有點浪費但最簡單能拿到餘額)
                        // 或我們等到使用者切換頁面時再更新也可。
                        // 這裡為了體驗好，先顯示 --- 等使用者互動。
                    });
                }
            }).catch(err => {
                document.getElementById('storeDisplay').innerText = "系統異常";
            });
        };

        // 頁面切換邏輯
        function switchTab(tabName) {
            // 切換按鈕樣式
            document.getElementById('tab-earn').classList.remove('active');
            document.getElementById('tab-redeem').classList.remove('active');
            document.getElementById('tab-' + tabName).classList.add('active');

            // 切換頁面顯示
            document.getElementById('page-earn').classList.add('d-none');
            document.getElementById('page-redeem').classList.add('d-none');
            document.getElementById('page-' + tabName).classList.remove('d-none');

            // 如果切到兌換頁，觸發載入
            if (tabName === 'redeem') {
                loadRewards();
            }
        }

        function doEarn() {
            const pointsInput = document.getElementById('inputPoints');
            const pinInput = document.getElementById('inputPinEarn');
            const btn = document.getElementById('btnEarn');
            
            if (!pointsInput.value || pointsInput.value <= 0 || !pinInput.value) {
                Swal.fire({ icon:'warning', title:'資料不完整', text:'請輸入點數與核銷碼' });
                return;
            }
            if (!currentUserProfile) return;

            callApi(btn, {
                action: 'add',
                userId: currentUserProfile.userId,
                points: pointsInput.value,
                storeId: currentStoreId,
                pin: pinInput.value
            }, (data) => {
                pinInput.value = ""; 
                updateBalanceUI(data.totalPoints); // 更新上方點數卡
                Swal.fire({
                    icon: 'success',
                    title: '集點成功',
                    html: `<div style="font-size:1.2rem">獲得 <b>${data.addedPoints}</b> 點</div>`,
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        }

        function loadRewards() {
            if (!currentUserProfile) return;
            const listDiv = document.getElementById('rewardList');
            
            // 保持 Loading 狀態
            // listDiv.innerHTML = '...'; 

            fetch(GAS_API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ 
                    action: 'getRewards',
                    userId: currentUserProfile.userId,
                    storeId: currentStoreId 
                })
            })
            .then(res => res.json())
            .then(data => {
                listDiv.innerHTML = ""; 
                
                // 順便更新餘額
                if(data.userBalance !== undefined) updateBalanceUI(data.userBalance);

                if (!data.rewards || data.rewards.length === 0) {
                    listDiv.innerHTML = "<p class='text-center w-100 mt-5 text-muted'>目前無可兌換商品</p>";
                    return;
                }

                data.rewards.forEach(item => {
                    const isOutOfStock = item.stock <= 0;
                    // 使用預設圖
                    const imgUrl = item.image && item.image.startsWith('http') ? item.image : "https://via.placeholder.com/300x200?text=Taiwan+Beer";
                    
                    const btnHtml = isOutOfStock 
                        ? `<button class="btn btn-secondary btn-redeem" disabled>已兌完</button>`
                        : `<button class="btn btn-outline-success btn-redeem" onclick="askRedeem('${item.name}', ${item.cost})">兌換</button>`;
                    
                    const stockHtml = isOutOfStock
                        ? `<span class="stock-badge out"><i class="fas fa-times-circle"></i> 缺貨</span>`
                        : `<span class="stock-badge"><i class="fas fa-check-circle"></i> 剩 ${item.stock}</span>`;

                    const html = `
                        <div class="reward-card">
                            <img src="${imgUrl}" class="reward-img" alt="${item.name}">
                            <div class="reward-body">
                                <div>
                                    <div class="reward-title">${item.name}</div>
                                    <div class="reward-meta">
                                        <span class="text-warning fw-bold"><i class="fas fa-gem"></i> ${item.cost}</span>
                                        ${stockHtml}
                                    </div>
                                </div>
                                ${btnHtml}
                            </div>
                        </div>
                    `;
                    listDiv.insertAdjacentHTML('beforeend', html);
                });
            })
            .catch(err => {
                listDiv.innerHTML = "<p class='text-danger text-center w-100'>載入失敗，請重試</p>";
            });
        }

        function askRedeem(rewardName, cost) {
            Swal.fire({
                title: '兌換確認',
                html: `商品：<b>${rewardName}</b><br>扣除：<b class="text-danger">${cost}</b> 點<br><br><small>請店員輸入核銷碼</small>`,
                input: 'password',
                inputAttributes: { maxlength: 4, placeholder: 'PIN Code' },
                showCancelButton: true,
                confirmButtonText: '確定兌換',
                confirmButtonColor: '#006633',
                cancelButtonText: '取消',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    if (!result.value) { Swal.fire('錯誤', '請輸入核銷碼', 'error'); return; }
                    
                    callApi(null, {
                        action: 'redeem',
                        userId: currentUserProfile.userId,
                        storeId: currentStoreId,
                        pin: result.value,
                        rewardName: rewardName,
                        cost: cost
                    }, (data) => {
                        updateBalanceUI(data.totalPoints);
                        loadRewards(); // 重整列表
                        Swal.fire({
                            icon: 'success',
                            title: '兌換成功',
                            html: `您已兌換 <b>${data.redeemedItem}</b>`,
                        });
                    });
                }
            });
        }

        function callApi(btnElement, payload, successCallback) {
            if (btnElement) { btnElement.disabled = true; btnElement.innerText = "處理中..."; }
            Swal.showLoading();

            fetch(GAS_API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (btnElement) { btnElement.disabled = false; btnElement.innerText = "確認集點"; }
                Swal.close();
                if (data.status === 'success') successCallback(data);
                else Swal.fire({ icon:'error', title:'Oops...', text: data.message });
            })
            .catch(err => {
                if (btnElement) btnElement.disabled = false;
                Swal.fire('錯誤', '網路連線異常', 'error');
            });
        }

        function updateBalanceUI(points) {
            // 加入數字跳動動畫效果
            const el = document.getElementById('headerPoints');
            el.innerText = points;
            el.classList.add('fade-in'); // 簡單的動畫重置邏輯可以更複雜，這裡從簡
        }
    </script>
</body>
</html>