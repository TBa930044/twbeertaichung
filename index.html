<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>(ä¸­éƒ¨)å°å•¤é›†é»æ´»å‹•</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-color: #006633; --accent-color: #FFC107; --bg-color: #f4f6f8; }
        
        /* 1. ä¿®æ”¹ï¼šå¤§å¹…å¢åŠ åº•éƒ¨ç•™ç™½è‡³ 25vhï¼Œç¢ºä¿é€£çµå¯ä»¥æ»‘åˆ°æœ€ä¸Šæ–¹ï¼Œä¸è¢«è­¦èªè“‹ä½ */
        body { background-color: var(--bg-color); font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 25vh; }
        
        .header-section {
            background: linear-gradient(135deg, #004d26 0%, #008040 100%); color: white; padding: 25px 20px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,80,0,0.25); position: relative; overflow: hidden;
        }
        .header-bg-circle { position: absolute; top: -30px; right: -30px; width: 180px; height: 180px; background: rgba(255,255,255,0.08); border-radius: 50%; }
        .user-greeting { font-size: 0.95rem; opacity: 0.9; margin-bottom: 5px; }
        .store-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; backdrop-filter: blur(4px); }
        .balance-card { margin-top: 20px; text-align: center; }
        .balance-number { font-size: 3.8rem; font-weight: 800; color: var(--accent-color); text-shadow: 0 2px 5px rgba(0,0,0,0.2); line-height: 1; }
        .balance-label { font-size: 0.9rem; opacity: 0.8; letter-spacing: 1px; }

        .custom-card { background: white; border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 15px; padding: 25px 20px; }
        
        /* è½‰ç›¤æ¨£å¼ */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 0 auto 20px auto; }
        .wheel {
            width: 100%; height: 100%; border-radius: 50%; border: 10px solid #004d26;
            position: relative; overflow: hidden; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            background: conic-gradient(#FFC107 0% 16.66%, #ffffff 16.66% 33.33%, #FFC107 33.33% 50%, #ffffff 50% 66.66%, #FFC107 66.66% 83.33%, #ffffff 83.33% 100%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        @keyframes spin-loading { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .wheel-loading { animation: spin-loading 0.6s linear infinite; }
        .wheel-text { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; transform-origin: 0 0; text-align: center; padding-top: 15px; font-weight: bold; font-size: 0.9rem; color: #333; }
        .txt-1 { transform: rotate(30deg) translateY(-140px) translateX(-50%); } 
        .txt-2 { transform: rotate(90deg) translateY(-140px) translateX(-50%); } 
        .txt-3 { transform: rotate(150deg) translateY(-140px) translateX(-50%); } 
        .txt-4 { transform: rotate(210deg) translateY(-140px) translateX(-50%); } 
        .txt-5 { transform: rotate(270deg) translateY(-140px) translateX(-50%); } 
        .txt-6 { transform: rotate(330deg) translateY(-140px) translateX(-50%); } 
        .wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid #dc3545; z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .wheel-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: white; border-radius: 50%; border: 4px solid #004d26; color: #004d26; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; z-index: 5; box-shadow: 0 0 10px rgba(0,0,0,0.2); cursor: pointer; }
        .wheel-btn:active { transform: translate(-50%, -50%) scale(0.95); }

        /* å°è¦½åˆ—æ¨£å¼ */
        .bottom-nav { 
            position: fixed; 
            bottom: 15vh; /* 2. ä¿®æ”¹ï¼šå°è¦½åˆ—å†å¾€ä¸Šæ¨ï¼Œé¿é–‹æ”¾å¤§çš„è­¦èª */
            left: 50%; transform: translateX(-50%); 
            width: 95%; max-width: 400px; 
            background: white; border-radius: 50px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            display: flex; 
            padding: 8px 5px; 
            z-index: 999; 
        }
        
        .nav-btn { 
            flex: 1; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 8px 0; border-radius: 40px; 
            color: #aaa; font-weight: bold; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            cursor: pointer; font-size: 0.75rem; line-height: 1.2;
        }
        
        .nav-btn i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-btn.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(0,102,51,0.3); }

        /* 3. ä¿®æ”¹ï¼šè­¦èªå€å¡Šæ”¾å¤§è¨­å®š */
        .warning-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: transparent;
            z-index: 9999;
            display: flex; justify-content: center; align-items: flex-end;
            padding: 0;
            box-shadow: none; 
            /* é—œéµï¼šæ”¾å¤§ 103%ï¼ŒåŸºæº–é»è¨­ç‚ºåº•éƒ¨ä¸­å¤® (å‘ä¸Šé•·é«˜) */
            transform: scale(1.05);
            transform-origin: bottom center;
        }
        
        .warning-img {
            width: 100%; height: auto; display: block;    
        }

        .form-control-custom { border: 2px solid #eee; border-radius: 12px; padding: 14px; font-size: 1.1rem; text-align: center; background-color: #fafafa; }
        .form-control-custom:focus { border-color: var(--primary-color); background-color: #fff; box-shadow: 0 0 0 3px rgba(0,102,51,0.1); }
        .btn-action { width: 100%; background: var(--primary-color); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; font-size: 1.1rem; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,102,51,0.3); transition: background-color 0.3s; }
        .btn-action:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-redeem { width: 100%; padding: 6px; font-size: 0.9rem; border-radius: 8px; }
        
        .d-none { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è¨»å†Šè¡¨å–®å°ˆç”¨æ¨£å¼ */
        .reg-label { text-align: left; width: 100%; margin-top: 10px; font-weight: bold; color: #333; }
        .reg-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; background: #f9f9f9; }
        .reg-check-group { display: flex; align-items: start; margin-top: 15px; text-align: left; font-size: 0.9rem; }
        .reg-check-group input { margin-top: 4px; margin-right: 8px; transform: scale(1.2); }
        .reg-link { color: #006633; text-decoration: underline; cursor: pointer; }
        
        .reward-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .reward-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; transition: transform 0.2s; }
        .reward-card:active { transform: scale(0.98); }
        .reward-img { width: 100%; height: 140px; object-fit: cover; background-color: #f0f0f0; }
        .reward-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .reward-title { font-size: 0.95rem; font-weight: bold; color: #333; margin-bottom: 5px; line-height: 1.3; height: 2.6em; overflow: hidden; }
        .reward-meta { font-size: 0.8rem; color: #666; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .store-select-container { background-color: #fff; padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color); }
        .form-select-custom { border: 2px solid #eee; border-radius: 8px; padding: 10px; font-size: 1rem; width: 100%; background-color: #fafafa; }
        
        /* 4. ä¿®æ”¹ï¼šé€£çµæ¨£å¼å¢åŠ  Z-Indexï¼Œç¢ºä¿ä¸è¢«è¦†è“‹ */
        .prize-link { 
            cursor: pointer; 
            color: #0d6efd; 
            transition: color 0.2s; 
            text-decoration: none; 
            display: inline-block; 
            padding: 5px;
            position: relative; /* é—œéµ */
            z-index: 10;        /* é—œéµï¼šæé«˜å±¤ç´šï¼Œä¿è­‰å¯é»æ“Š */
        }
    </style>
</head>
<body>

<div class="warning-footer">
    <img src="https://www.mof.gov.tw/getCKEditorImage?localFileName=/upload/content/image/24459517be4749a48857e6f6acb375eb/1737614098799_5132689576360529.png&portalUuid=89407691a61e484a84a83c78c693fd78" 
         alt="ç¦æ­¢é…’é§•" 
         class="warning-img">
</div>

    <div class="header-section">
        <div class="header-bg-circle"></div>
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="user-greeting" id="userGreeting">Hi, æœƒå“¡</div>
                <div style="font-weight:bold; font-size:1.2rem;">
                    <i class="fas fa-beer"></i> å°ç£å•¤é…’
                </div>
            </div>
            <div class="store-badge" id="storeDisplay">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
        <div class="balance-card">
            <div class="balance-number" id="headerPoints">...</div>
            <div class="balance-label">ç›®å‰æŒæœ‰é»æ•¸</div>
        </div>
    </div>

    <div class="container mt-3">
        <div id="page-earn" class="fade-in">
            <div class="custom-card">
                <h5 class="fw-bold mb-4" style="color:#333;"><i class="fas fa-qrcode me-2 text-success"></i>æƒç¢¼é›†é»</h5>
                <div class="mb-3">
                    <label class="text-muted small mb-2 fw-bold">æ¶ˆè²»ç“¶æ•¸ / é‡‘é¡</label>
                    <input type="number" id="inputPoints" class="form-control form-control-custom" placeholder="è«‹è¼¸å…¥æœ¬æ¬¡æ¶ˆè²»å°å•¤ç“¶æ•¸" min="1">
                </div>
                <div class="mb-3">
                    <label class="text-muted small mb-2 fw-bold">è«‹åº—å“¡è¼¸å…¥æ ¸éŠ·ç¢¼</label>
                    <input type="password" id="inputPinEarn" class="form-control form-control-custom" placeholder="PIN Code" maxlength="4">
                </div>
                <button id="btnEarn" class="btn-action" onclick="doEarn()" disabled>é€£ç·šä¸­...</button>
            </div>
            <div class="custom-card py-3 text-center" style="background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;">
                <small><i class="fas fa-info-circle me-1"></i> è«‹å‘åº—å“¡å‡ºç¤ºæœ¬ç•«é¢é€²è¡Œé›†é»</small>
            </div>
        </div>

        <div id="page-redeem" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;å¥½ç¦®å…Œæ›å°ˆå€</h5>
            <div id="storeSelectArea" class="store-select-container d-none">
                <label class="text-muted small mb-1 fw-bold"><i class="fas fa-store-alt me-1"></i> æŸ¥è©¢å„åº—åº«å­˜</label>
                <select id="storeSelect" class="form-select form-select-custom" onchange="loadRewards()">
                    <option value="" disabled selected>è¼‰å…¥åº—å®¶æ¸…å–®ä¸­...</option>
                </select>
            </div>
            <div id="rewardList" class="reward-grid">
                <div class="text-center w-100 py-4" style="grid-column: span 2;"><div class="spinner-border text-success" role="status"></div></div>
            </div>
            <div style="height: 100px;"></div> 
        </div>

        <div id="page-game" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;å¹¸é‹å¤§è½‰ç›¤</h5>
            <div class="custom-card text-center" style="background: #e8f5e9;">
                <p class="mb-2 fw-bold" style="color:#004d26;">ä»¥å°åšå¤§ï¼æ¯æ¬¡åªéœ€ <span class="text-danger">2</span> é»</p>
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="wheel" id="wheel">
                        <div class="wheel-text txt-1">æ‹‰æ¡¿<br>å†°æ¡¶</div>
                        <div class="wheel-text txt-2">éŠ˜è¬<br>æƒ é¡§</div>
                        <div class="wheel-text txt-3">20å‹<br>è¡Œæç®±</div>
                        <div class="wheel-text txt-4">éŠ˜è¬<br>æƒ é¡§</div>
                        <div class="wheel-text txt-5">éŠ˜è¬<br>æƒ é¡§</div>
                        <div class="wheel-text txt-6">éŠ˜è¬<br>æƒ é¡§</div>
                    </div>
                    <div class="wheel-btn" onclick="doPlayGame()" id="spinBtn">GO</div>
                </div>
                
                <div class="mt-3">
                    <div class="prize-link" onclick="showPrizeImage('æ‹‰æ¡¿å†°æ¡¶', 'https://github.com/TBa930044/twbeertaichung/blob/main/ice.png?raw=true')">
                        <i class="fas fa-gift"></i> å¤§çï¼šæ‹‰æ¡¿å†°æ¡¶ (æ¥µç¨€æœ‰) <i class="fas fa-search-plus small"></i>
                    </div>
                    <br>
                    <div class="prize-link" onclick="showPrizeImage('20å‹ç©ºè»è—è¡Œæç®±', 'https://eshop.ttl.com.tw/uploadphoto/images/thumbs/0000487_taiwan-beer-x-eminent-20_600.jpeg')">
                        <i class="fas fa-suitcase"></i> äºŒçï¼š20å‹ç©ºè»è—è¡Œæç®± <i class="fas fa-search-plus small"></i>
                    </div>
                </div>
            </div>
            <div style="height: 100px;"></div> 
        </div>

        <div id="page-history" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;è¿‘æœŸäº¤æ˜“ç´€éŒ„</h5>
            <div id="historyList" class="history-list">
                <div class="text-center w-100 py-4"><div class="spinner-border text-success" role="status"></div></div>
            </div>
            <div style="height: 100px;"></div> 
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" id="tab-earn" onclick="switchTab('earn')">
            <i class="fas fa-camera"></i>
            <span>é›†é»</span>
        </div>
        <div class="nav-btn" id="tab-redeem" onclick="switchTab('redeem')">
            <i class="fas fa-gift"></i>
            <span>å…Œæ›</span>
        </div>
        <div class="nav-btn" id="tab-game" onclick="switchTab('game')">
            <i class="fas fa-dharmachakra"></i>
            <span>éŠæˆ²</span>
        </div>
        <div class="nav-btn" id="tab-history" onclick="switchTab('history')">
            <i class="fas fa-history"></i>
            <span>ç´€éŒ„</span>
        </div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYI4M2RuswYcxoMy98Gr8WLinypnvZwrYAwtHsD84rX0unB26FKKx4u0dcuB9Ojo62/exec"; 
        const MY_LIFF_ID = "2008765350-4KBTGWMz"; 
        
        const urlParams = new URLSearchParams(window.location.search);
        let storeParam = urlParams.get('store');
        if (!storeParam && window.location.hash) {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            storeParam = hashParams.get('store');
        }
        if (storeParam) { localStorage.setItem('savedStoreId', storeParam); } 
        else { const saved = localStorage.getItem('savedStoreId'); if (saved) storeParam = saved; }

        const currentStoreId = storeParam || 'store01'; 
        let currentUserProfile = null;
        const isViewOnly = (currentStoreId === 'store00');

        window.onload = function() {
            document.getElementById('headerPoints').innerText = "è¼‰å…¥ä¸­..."; 
            document.getElementById('headerPoints').style.fontSize = "1.5rem";

            if (isViewOnly) {
                document.getElementById('storeDisplay').innerHTML = `<i class="fas fa-search me-1"></i> é›†é»æŸ¥è©¢`;
                document.getElementById('inputPoints').disabled = true;
                document.getElementById('inputPoints').placeholder = "åƒ…ä¾›æŸ¥è©¢";
                document.getElementById('inputPinEarn').disabled = true;
                document.getElementById('inputPinEarn').placeholder = "è«‹è‡³é–€å¸‚é›†é»";
                const btn = document.getElementById('btnEarn');
                btn.disabled = true;
                btn.innerText = "æ­¤æ¨¡å¼åƒ…ä¾›æŸ¥è©¢é¤˜é¡";
                document.getElementById('storeSelectArea').classList.remove('d-none');
                loadStoreList(); 
            } else {
                document.getElementById('storeDisplay').innerHTML = `<i class="fas fa-map-marker-alt me-1"></i> ${currentStoreId}`;
            }

            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    let loginRedirect = window.location.href;
                    if(currentStoreId && !window.location.search.includes('store')) {
                         loginRedirect = loginRedirect.split('?')[0] + '?store=' + currentStoreId;
                    }
                    liff.login({ redirectUri: loginRedirect });
                } else {
                    liff.getProfile().then(profile => { 
                        currentUserProfile = profile;
                        if(profile.displayName) document.getElementById('userGreeting').innerText = `Hi, ${profile.displayName}`;
                        if(!isViewOnly) {
                            const btn = document.getElementById('btnEarn');
                            btn.disabled = false;
                            btn.innerText = "ç¢ºèªé›†é»";
                        }
                        checkBalanceAndRegister(profile.userId);
                    });
                }
            }).catch(console.error);
        };

        function checkBalanceAndRegister(userId) {
            fetch(GAS_API_URL, { 
                method: "POST", headers: { "Content-Type": "text/plain" }, 
                body: JSON.stringify({ action: 'checkBalance', userId: userId }) 
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('headerPoints').style.fontSize = "3.8rem";
                if(data.userBalance !== undefined) updateBalanceUI(data.userBalance);
                if (data.isRegistered === false) {
                    showRegistrationModal(userId);
                }
            })
            .catch(err => { document.getElementById('headerPoints').innerText = "---"; });
        }

        function showRegistrationModal(userId) {
            Swal.fire({
                title: 'ç¬¬ä¸€æ¬¡æƒæå‰<br>è«‹å…ˆå¡«å¯«åŸºæœ¬è³‡æ–™',
                html: `
                    <div style="font-size:0.9rem; color:#666; margin-bottom:15px;">ä»¥ä½œç‚ºå¾ŒçºŒè´ˆå“å¯„é€ä½¿ç”¨</div>
                    <label class="reg-label">çœŸå¯¦å§“å</label>
                    <input id="reg-name" class="reg-input" placeholder="ç‹å°æ˜">
                    <label class="reg-label">é€£çµ¡é›»è©±</label>
                    <input id="reg-phone" class="reg-input" type="tel" placeholder="0912345678">
                    <label class="reg-label">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input id="reg-dob" class="reg-input" type="date">
                    <div class="reg-check-group">
                        <input type="checkbox" id="check-age">
                        <label for="check-age">æˆ‘æ˜¯è¨­ç±ä¸”å±…ä½æ–¼ä¸­è¯æ°‘åœ‹ä¹‹å¹´æ»¿18è¶³æ­²æœ¬åœ‹å…¬æ°‘</label>
                    </div>
                    <div class="reg-check-group">
                        <input type="checkbox" id="check-terms">
                        <label for="check-terms">æˆ‘å·²è©³é–±äº†è§£ä¸¦åŒæ„éµå®ˆæœ¬æ´»å‹•æ‰€å…¬å¸ƒçš„ <span class="reg-link" onclick="showTerms('${userId}')">æ´»å‹•è¾¦æ³•æš¨å€‹äººè³‡æ–™åŒæ„è²æ˜</span></label>
                    </div>
                `,
                confirmButtonText: 'ç¢ºèªé€å‡º',
                confirmButtonColor: '#006633',
                allowOutsideClick: false,
                allowEscapeKey: false,
                width: '90%',
                preConfirm: () => {
                    const name = document.getElementById('reg-name').value;
                    const phone = document.getElementById('reg-phone').value;
                    const dob = document.getElementById('reg-dob').value;
                    const checkAge = document.getElementById('check-age').checked;
                    const checkTerms = document.getElementById('check-terms').checked;
                    if (!name || !phone || !dob) { Swal.showValidationMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½'); return false; }
                    if (!checkAge) { Swal.showValidationMessage('å¿…é ˆå¹´æ»¿18æ­²æ‰èƒ½åƒåŠ '); return false; }
                    if (!checkTerms) { Swal.showValidationMessage('è«‹åŒæ„æ´»å‹•è¾¦æ³•'); return false; }
                    const today = new Date();
                    const birthDate = new Date(dob);
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; }
                    if (age < 18) { Swal.showValidationMessage('æŠ±æ­‰ï¼Œæ‚¨æœªæ»¿18æ­²ï¼Œç„¡æ³•åƒåŠ æœ¬æ´»å‹•ã€‚'); return false; }
                    return { name: name, phone: phone, dob: dob };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    registerUser(userId, result.value);
                }
            });
        }

        function registerUser(userId, data) {
            Swal.fire({ title: 'è³‡æ–™å»ºç«‹ä¸­...', didOpen: () => { Swal.showLoading() } });
            fetch(GAS_API_URL, { 
                method: "POST", headers: { "Content-Type": "text/plain" }, 
                body: JSON.stringify({ action: 'registerUser', userId: userId, name: data.name, phone: data.phone, dob: data.dob }) 
            })
            .then(res => res.json())
            .then(resData => {
                if (resData.status === 'success') {
                    Swal.fire({ icon: 'success', title: 'è¨»å†ŠæˆåŠŸ', text: 'æ­¡è¿åƒåŠ æ´»å‹•ï¼', confirmButtonColor: '#006633' });
                } else {
                    Swal.fire('éŒ¯èª¤', 'è¨»å†Šå¤±æ•—ï¼Œè«‹é‡è©¦', 'error').then(() => showRegistrationModal(userId));
                }
            });
        }

        function showTerms(userId) {
            Swal.fire({
                title: 'æ´»å‹•è¾¦æ³•æš¨å€‹è³‡è²æ˜',
                html: `
                    <div style="text-align:left; max-height:60vh; overflow-y:auto; font-size:0.9rem; line-height:1.6; padding-right:5px;">
                        <h5 style="color:#006633; font-weight:bold; border-bottom: 2px solid #FFC107; padding-bottom:5px;">ä¸€ã€æ´»å‹•è¾¦æ³•</h5>
                        <p>éå¸¸æ„Ÿè¬æ‚¨åƒèˆ‡(ä¸­éƒ¨)å°ç£å•¤é…’é›†é»æ´»å‹•(ä»¥ä¸‹ç°¡ç¨±æœ¬æ´»å‹•)ã€‚åœ¨æš¢é£²å°ç£å•¤é…’æ™‚ï¼Œè¨˜å¾—ç†æ€§é£²é…’ï¼Œæˆ‘å€‘é‡è¦–æ‚¨çš„èº«å¿ƒå¥åº·èˆ‡å®‰å…¨ï¼Œå¸Œæœ›å°ç£å•¤é…’èƒ½æŒçºŒé™ªä¼´æ‚¨äººç”Ÿä¸­å„ç¨®æ™‚åˆ»ï¼Œä¸¦äº«å—æœ¬æ¬¡æ´»å‹•çµ¦æ‚¨çš„é«”é©—ã€‚</p>
                        <p><strong>ã€æ´»å‹•èªªæ˜ã€‘</strong><br>é›†é»æ´»å‹•æœŸé–“ï¼Œæ–¼æŒ‡å®šé€šè·¯æ¶ˆè²»0.6Lç“¶è£18å¤©ç”Ÿå•¤é…’æˆ–é‡‘ç‰ŒONEå•¤é…’ä»»1ç“¶ï¼Œå³å¯åƒåŠ æ´»å‹•ã€‚</p>
                        <p><strong>ã€æ´»å‹•æ©Ÿåˆ¶ã€‘</strong><br>æ–¼çµå¸³æ™‚ï¼Œè¼¸å…¥æœ¬æ¬¡æ¶ˆè²»ç“¶æ•¸ï¼Œç¶“çµå¸³äººå“¡ç¢ºèªå¾Œï¼Œå³å¯ç²å¾—é»æ•¸(1ç“¶1é»)ã€‚é»æ•¸å¯æ–¼æœ¬æ´»å‹•å¹³å°å…Œæ›å¥½ç¦®æˆ–æ˜¯æ¶ˆè€—2é»ä»¥å°åšå¤§åƒåŠ è½‰ç›¤éŠæˆ²ã€‚</p>
                        <p><strong>ã€æ´»å‹•æœŸé–“ã€‘</strong><br>2026å¹´4æœˆ1æ—¥00:00èµ·è‡³2026å¹´5æœˆ31æ—¥23:59çµæŸã€‚</p>
                        <p><strong>ã€é»æ•¸å…Œæ›æœŸé–“ã€‘</strong><br>2026å¹´4æœˆ1æ—¥00:00èµ·è‡³2026å¹´6æœˆ30æ—¥23:59çµæŸã€‚</p>
                        <p><strong>ã€æ³¨æ„äº‹é …ã€‘</strong><br>1. æœ¬æ´»å‹•ä¸»è¾¦å–®ä½ç‚ºè‡ºç£è¸é…’å…¬å¸è‡ºä¸­ç‡Ÿæ¥­è™•ã€‚<br>2. æœ¬æ´»å‹•é™å¹´æ»¿18è¶³æ­²è€…å§‹å¾—åƒåŠ ã€‚<br>3. é›†é»å…Œæ›æœŸé–“çµ‚äº†å¾Œï¼Œæœªå…Œæ›é»æ•¸å°‡è‡ªå‹•å¤±æ•ˆï¼Œä¸å¾—è¦æ±‚ä»»ä½•å½¢å¼ä¹‹è£œå„Ÿã€‚<br>4. æœ¬æ´»å‹•ä¹‹å¥½ç¦®ä»¥å¯¦ç‰©ç‚ºæº–ï¼Œç¶²é åŠå„å¼å®£å‚³ç‰©åœ–ç‰‡åƒ…ä¾›åƒè€ƒã€‚<br>5. å¥½ç¦®æ•¸é‡æœ‰é™ï¼Œæ›å®Œç‚ºæ­¢ï¼Œæ•ä¸åŠ é‡ã€‚å…Œæ›é †åºä»¥ç³»çµ±æ™‚é–“ç‚ºæº–ã€‚ä¸­çäººä¸å¾—è¦æ±‚å°‡å¥½ç¦®å…Œæ›å…¶ä»–ç­‰å€¼å•†å“æˆ–ç¾é‡‘ã€‚<br>6. æœªæ–¼ä¸»è¾¦å–®ä½æŒ‡å®šæ™‚é–“å…§æä¾›è¾¦ç†å…Œçä½œæ¥­æ‰€éœ€è³‡æ–™æˆ–æœªä¾ä¸»è¾¦å–®ä½æŒ‡ç¤ºä¹‹æ–¹å¼è¾¦ç†ï¼Œè¦–ç‚ºä¸»å‹•æ”¾æ£„ä¸­çè³‡æ ¼ã€‚<br>7. åƒåŠ è€…å¡«å¯«æˆ–æå‡ºä¹‹è³‡æ–™æ‡‰å±¬çœŸå¯¦ã€æ­£ç¢ºä¸”æœªå†’ç”¨æˆ–ç›œç”¨ä»–äººè³‡æ–™ï¼Œå¦‚æœ‰ä¸å¯¦æˆ–ä¸æ­£ç¢ºè³‡è¨Šå°è‡´ä¸»è¾¦å–®ä½ç„¡æ³•è¯çµ¡åƒåŠ è€…ï¼Œå‰‡è¦–åŒæ”¾æ£„ä¸­çè³‡æ ¼ä¸”ä¸»è¾¦å–®ä½ç„¡éœ€ä»»ä½•è²¬ä»»ï¼›å€˜æœ‰æå®³ä¸»è¾¦å–®ä½æˆ–å…¶ä»–ä»»ä½•ç¬¬ä¸‰äººä¹‹è¡Œç‚ºï¼ŒåƒåŠ è€…å°šæ‡‰å°±æ­¤è² ä¸€åˆ‡æ°‘ã€åˆ‘äº‹è²¬ä»»ã€‚<br>8. åƒåŠ è€…è‹¥ä»¥æƒ¡æ„ä¹‹é›»è…¦ç¨‹å¼æˆ–å…¶ä»–æ˜é¡¯é•åæ´»å‹•å…¬å¹³æ€§ä¹‹æ–¹å¼ï¼Œæ„åœ–æ··æ·†æˆ–å½±éŸ¿æ´»å‹•çµæœè€…ï¼Œä¸€ç¶“ä¸»è¾¦å–®ä½å¯Ÿè¦ºï¼Œä¸»è¾¦å–®ä½å¾—ç«‹å³å–æ¶ˆåƒåŠ è€…ä¹‹ä¸­çè³‡æ ¼ï¼Œä¸¦å¯è¿½å›çå“ã€‚<br>9. åƒåŠ è€…åŒæ„æ‰€æœ‰åƒåŠ è€…æ‰€ç•™å­˜æˆ–ç”¢ç”Ÿä¹‹ä»»ä½•åƒèˆ‡æ´»å‹•çš„è³‡æ–™åŠè¨˜éŒ„ï¼Œçš†ä»¥ä¸»è¾¦å–®ä½çš„é›»è…¦ç³»çµ±èˆ‡æ™‚é–“çš„ç´€éŒ„ç‚ºä¸»ï¼Œå¦‚æœ‰ä»»ä½•å› é›»è…¦ã€ç¶²è·¯ã€é›»è©±ã€æŠ€è¡“æˆ–ä¸å¯æ­¸è²¬æ–¼ä¸»è¾¦å–®ä½ä¹‹äº‹ç”±ï¼Œè€Œä½¿åƒåŠ è€…æ‰€å¯„å‡ºæˆ–ç™»éŒ„ä¹‹è³‡æ–™æœ‰å»¶é²ã€éºå¤±ã€éŒ¯èª¤ã€ç„¡æ³•è¾¨è­˜æˆ–æ¯€æä¹‹æƒ…æ³ï¼Œä¸»è¾¦å–®ä½ä¸è² ä»»ä½•æ³•å¾‹è²¬ä»»ï¼ŒåƒåŠ è€…äº¦ä¸å¾—å› æ­¤ç•°è­°ã€‚<br>10. ä¾ä¸­è¯æ°‘åœ‹ç¨…æ³•è¦å®šï¼Œä¸­çé‡‘é¡ï¼ˆåƒ¹å€¼ï¼‰è¶…éæ–°å°å¹£1,000å…ƒï¼ˆä¸å«ï¼‰è€…ï¼Œéœ€ç¹³äº¤èº«åˆ†è­‰æ­£åé¢å½±æœ¬ä¾›å ±ç¨…ä½¿ç”¨ã€‚æ–¼ä¸­çè€…å¹´åº¦å€‹äººç¶œåˆæ‰€å¾—ç¨…è¨ˆç®—æ™‚ï¼Œä¸­çé‡‘é¡ï¼ˆåƒ¹å€¼ï¼‰å°‡è¨ˆå…¥å…¶å€‹äººæ‰€å¾—ã€‚ä¸­çé‡‘é¡ï¼ˆåƒ¹å€¼ï¼‰è¶…éæ–°å°å¹£20,000å…ƒï¼ˆä¸å«ï¼‰è€…ï¼Œä¸­çè€…é ˆå…ˆè¡Œç¹³äº¤ç›¸ç•¶æ–¼ä¸­çé‡‘é¡ï¼ˆåƒ¹å€¼ï¼‰10%ä¹‹æ©Ÿæœƒä¸­çæ‰€å¾—ç¨…å¾Œæ–¹å¯é ˜çï¼›ä¸­çè€…è‹¥éä¸­è¯æ°‘åœ‹åœ‹å¢ƒå…§è¨­ç±ä¹‹åœ‹äººï¼ˆå³ä¾æ³•æ–¼èª²ç¨…å¹´åº¦å…§ï¼Œåœ¨ä¸­è¯æ°‘åœ‹å¢ƒå…§å±…ä½æœªé”183å¤©ä¹‹æœ¬åœ‹äººå«å¤§é™¸äººå£«åŠå¤–åœ‹äººï¼‰ï¼Œä¸è«–ä¸­çè€…æ‰€å¾—çé …ä¹‹åƒ¹å€¼ï¼Œéœ€é å…ˆæ‰£ç¹³20%æ©Ÿæœƒä¸­çç¨…é‡‘ï¼Œå¾…ä¸­çè€…ä»˜æ¸…ç¨…é‡‘å¾Œæ–¹å¯é ˜çã€‚è‹¥ä¸­çè€…ä¸é¡˜å…ˆè¡Œç¹³ç´æœ¬é …ç¨…é‡‘ï¼Œè¦–åŒæ”¾æ£„ä¸­çè³‡æ ¼ï¼Œä¸”ä¸å¾—ç•°è­°ã€‚ä¸­çè€…åƒåŠ æœ¬æ´»å‹•è€Œéœ€æ”¯ä»˜ä»»ä½•ç¨…æçš†ç‚ºä¸­çè€…ä¹‹æ³•å®šç¾©å‹™ï¼Œæ¦‚èˆ‡ä¸»è¾¦å–®ä½ç„¡é—œã€‚ä¾è²¡æ”¿éƒ¨åœ‹ç¨…å±€ã€Œæ†‘å–®ç„¡ç´™åŒ–ã€æ”¿ç­–ï¼Œä¸»è¾¦å–®ä½å°‡ä¾è¦å®šå‘åœ‹ç¨…å±€è¾¦ç†æ†‘å–®ç”³å ±ï¼Œä¸¦å…å¯„ç™¼æ†‘å–®çµ¦ä¸­çè€…ï¼Œä¸­çè€…éœ€è‡ªè¡Œæ–¼éš”å¹´5æœˆåº•å‰å®Œæˆç”³å ±ã€‚<br>11. ä¸»è¾¦å–®ä½ä¿ç•™ä¿®æ”¹æ´»å‹•èˆ‡çé …ç´°ç¯€çš„æ¬Šåˆ©ï¼Œç„¡é ˆäº‹å‰é€šçŸ¥ï¼Œä¸¦æœ‰æ¬Šå°æœ¬æ´»å‹•æ‰€æœ‰äº‹å®œä½œå‡ºè§£é‡‹æˆ–è£æ±ºã€‚å…¶ä»–æœªç›¡äº‹å®œï¼Œæ‚‰ä¾ä¸»è¾¦å–®ä½ç›¸é—œè¦å®šï¼Œä¸»è¾¦å–®ä½ä¸¦ä¿æœ‰æœ€çµ‚è§£é‡‹æ¬Šã€‚<br>12. åƒåŠ è€…åŒæ„ä¸å°ä¸»è¾¦å–®ä½åŠå…¶å·¥ä½œäººå“¡ï¼Œå°±æœ¬æ´»å‹•å¯èƒ½ç™¼ç”Ÿä¹‹ä»»ä½•æ„å¤–æˆ–æå®³æå‡ºä»»ä½•å½¢å¼ä¹‹æ±‚å„Ÿã€‚<br>13. è‹¥ä¸»è¾¦å–®ä½åˆç†èªç‚ºä»»ä½•åƒèˆ‡è€…æœ‰é•åæœ¬åŒæ„æ›¸è¦ç¯„ä¹‹è™ï¼Œä¸»è¾¦å–®ä½å¾—æ‹’çµ•å…¶åƒèˆ‡æœ¬æ´»å‹•ã€‚</p>
                        <h5 style="color:#006633; font-weight:bold; margin-top:20px; border-bottom: 2px solid #FFC107; padding-bottom:5px;">äºŒã€å€‹äººè³‡æ–™</h5>
                        <p>1. <strong>è’é›†å–®ä½ï¼š</strong>ä¸»è¾¦å–®ä½ã€æˆ–åœ¨æ³•ä»¤è¨±å¯ä¹‹ç¯„åœæˆ–åƒåŠ è€…åŒæ„ä¸‹å—æœ¬å…¬å¸å§”è¨—å¾äº‹éƒµå¯„ã€é‹é€ã€æ´»å‹•èˆ‰è¾¦ã€åŸ·è¡Œç ”ç©¶ç­‰èª¿æŸ¥ï¼ˆå¦‚æœ‰ï¼‰ä¹‹ç¬¬ä¸‰äººï¼ˆä»¥ä¸‹ç°¡ç¨±åŸ·è¡Œæ©Ÿæ§‹ï¼‰ã€‚<br>2. <strong>è’é›†ç›®çš„ï¼š</strong>é™¤ç›¸é—œæ´»å‹•è¦å‰‡å¦æœ‰å‘ŠçŸ¥å¤–ï¼Œå€‹äººè³‡æ–™å°‡ç”¨æ–¼åƒåŠ è€…åƒåŠ ä¸»è¾¦å–®ä½æ´»å‹•ä¹‹ç›¸é—œç”¨é€”åŠç‚ºä¸»è¾¦å–®ä½ï¼ˆæˆ–åŸ·è¡Œæ©Ÿæ§‹ï¼‰é€²è¡Œè¯çµ¡åŠé ˜çä¹‹ç¢ºèªèº«åˆ†ã€ç”¢å“æ¨å»£å®£å‚³ã€è¡ŒéŠ·ã€å¸‚å ´èª¿æŸ¥ã€ç ”ç©¶ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼å°æ–¼å…§å®¹é€²è¡Œçµ±è¨ˆèˆ‡åˆ†æï¼Œåˆ†æçµæœä¹‹çµ±è¨ˆæ•¸æ“šæˆ–èªªæ˜æ–‡å­—å‘ˆç¾ï¼›é™¤ä¾›å…§éƒ¨ç ”ç©¶å¤–ï¼Œä¸»è¾¦å–®ä½å¯èƒ½è¦–éœ€è¦å…¬ä½ˆçµ±è¨ˆæ•¸æ“šåŠèªªæ˜æ–‡å­—ï¼Œä½†ä¸æ¶‰åŠç‰¹å®šå€‹äººè³‡æ–™ï¼‰ä¹‹ç”¨ç­‰ã€‚<br>3. <strong>é¡åˆ¥ï¼š</strong>é™¤ç›¸é—œæ´»å‹•è¦å‰‡å¦æœ‰å‘ŠçŸ¥å¤–ï¼Œå§“åã€èº«åˆ†è­‰å­—è™Ÿã€å‡ºç”Ÿå¹´æœˆæ—¥ã€é›»è©±ã€åœ°å€ã€é›»éƒµä¿¡ç®±ã€LINE å¸³è™Ÿä¹‹å…§éƒ¨è­˜åˆ¥ç¢¼ç­‰è³‡è¨Šã€‚<br>4. <strong>åˆ©ç”¨å°è±¡ï¼š</strong>ä¸»è¾¦å–®ä½æˆ–åŸ·è¡Œæ©Ÿæ§‹ã€‚é™¤ä¸Šæ‰€è¿°å¤–ï¼Œä¸»è¾¦å–®ä½æˆ–åŸ·è¡Œæ©Ÿæ§‹çµ•å°ä¸æœƒä»»æ„å‡ºå”®ã€äº¤æ›ã€å‡ºç§Ÿæˆ–ä»¥å…¶ä»–è®Šç›¸ä¹‹æ–¹å¼ï¼Œå°‡åƒåŠ è€…çš„å€‹äººè³‡æ–™æ­éœ²äºˆå…¶ä»–åœ˜é«”æˆ–å€‹äººï¼ŒæƒŸç™¼ç”Ÿä»¥ä¸‹æƒ…å½¢è€…ä¸åœ¨æ­¤é™ï¼šç¶“éåƒåŠ è€…çš„äº‹å‰åŒæ„æˆ–æˆæ¬Šå…è¨±æ™‚ã€å¸æ³•å–®ä½æˆ–å…¶ä»–ä¸»ç®¡æ©Ÿé—œç¶“åˆæ³•æ­£å¼çš„ç¨‹åºè¦æ±‚æ™‚ã€ç‚ºäº†æä¾›åƒåŠ è€…å…¶ä»–æœå‹™æˆ–å„ªæƒ æ¬Šç›Šï¼Œéœ€è¦èˆ‡æä¾›è©²æœå‹™æˆ–å„ªæƒ ä¹‹ç¬¬ä¸‰è€…å…±ç”¨åƒåŠ è€…çš„è³‡æ–™æ™‚ï¼Œä¸»è¾¦å–®ä½æˆ–åŸ·è¡Œæ©Ÿæ§‹æœƒåœ¨æ´»å‹•æ™‚æä¾›å……åˆ†èªªæ˜ä¸¦å‘ŠçŸ¥ï¼ŒåƒåŠ è€…å¯ä»¥è‡ªç”±é¸æ“‡æ˜¯å¦æ¥å—é€™é …æœå‹™æˆ–å„ªæƒ ã€‚<br>5. <strong>åˆ©ç”¨æœŸé–“èˆ‡å€åŸŸï¼š</strong>ä¸»è¾¦å–®ä½æˆ–åŸ·è¡Œæ©Ÿæ§‹å°‡æŒçºŒä½¿ç”¨åƒåŠ è€…æä¾›çš„å€‹äººè³‡æ–™ç›´è‡³åƒåŠ è€…æå‡ºåœæ­¢ä½¿ç”¨ä¹‹æ—¥ç‚ºæ­¢ã€‚åƒåŠ è€…çš„å€‹äººè³‡æ–™ä½¿ç”¨å€åŸŸåƒ…é™æ–¼å°ç£åœ°å€å…§ä½¿ç”¨ã€‚<br>6. <strong>å€‹äººè³‡æ–™ä¿è­·æ³•ç¬¬ä¸‰æ¢ä¹‹æ¬Šåˆ©è¡Œä½¿æ–¹å¼ï¼š</strong>æ›¸é¢å¯„é€è‡³ä¸»è¾¦å–®ä½æˆ–åŸ·è¡Œæ©Ÿæ§‹ç™»è¨˜åœ°å€æˆ–1081013@mail.ttl.com.twã€‚<br>7. ä¸»è¾¦å–®ä½æˆ–åŸ·è¡Œæ©Ÿæ§‹å°‡åœ¨è’é›†ç›®çš„ç¯„åœå…§è™•ç†åŠåˆ©ç”¨åƒåŠ è€…çš„å€‹äººè³‡æ–™ï¼›éç¶“åƒåŠ è€…æ›¸é¢åŒæ„ï¼Œä¸»è¾¦å–®ä½æˆ–åŸ·è¡Œæ©Ÿæ§‹ä¸æœƒå°‡å€‹äººè³‡æ–™ç”¨æ–¼å…¶ä»–ç”¨é€”ã€‚<br>8. åƒåŠ è€…å¯è‡ªç”±é¸æ“‡æ˜¯å¦æä¾›å€‹äººè³‡æ–™ï¼ŒæƒŸè‹¥æœ¬äººé¸æ“‡ä¸æä¾›å€‹äººè³‡æ–™æˆ–æä¾›ä¸å®Œå…¨æ™‚ï¼Œä¸»è¾¦å–®ä½æˆ–åŸ·è¡Œæ©Ÿæ§‹å°‡ç„¡æ³•é€²è¡Œå¿…è¦ä¹‹è™•ç†ä½œæ¥­ã€‚</p>
                        <h5 style="color:#dc3545; font-weight:bold; margin-top:20px; text-align:center;"><i class="fas fa-exclamation-triangle"></i> ç¦æ­¢é…’é§•ï¼Œæœªæ»¿18æ­²ç¦æ­¢é£²é…’</h5>
                    </div>
                `,
                confirmButtonText: 'æˆ‘å·²é–±è®€å®Œç•¢',
                confirmButtonColor: '#006633',
                allowOutsideClick: false
            }).then(() => {
                showRegistrationModal(userId);
            });
        }

        function showPrizeImage(title, imgUrl) {
            Swal.fire({
                title: title,
                html: `<div class="mb-3"><button onclick="Swal.close()" class="btn btn-success w-100 fw-bold" style="background-color: #006633; border-color: #006633; padding: 12px; font-size: 1.1rem;"><i class="fas fa-times-circle"></i> é—œé–‰åœ–ç‰‡</button></div><img src="${imgUrl}" style="width:100%; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">`,
                showConfirmButton: false, showCloseButton: false, allowOutsideClick: true, customClass: { popup: 'swal-wide' }
            });
        }

        let isSpinning = false;
        function doPlayGame() {
            if (isSpinning) return;
            if (!currentUserProfile) return;
            Swal.fire({
                title: 'å¹¸é‹å¤§è½‰ç›¤', text: "ç¢ºå®šè¦æ‰£é™¤ 2 é»é€²è¡ŒæŠ½çå—ï¼Ÿ", icon: 'question', showCancelButton: true, confirmButtonText: 'é–‹å§‹è½‰å‹•ï¼', cancelButtonText: 'ç­‰ç­‰', confirmButtonColor: '#006633'
            }).then((result) => { if (result.isConfirmed) startSpin(); });
        }

        function startSpin() {
            if (isSpinning) return;
            isSpinning = true;
            document.getElementById('spinBtn').style.opacity = 0.5;
            
            const wheel = document.getElementById('wheel');
            wheel.style.transition = 'none';
            wheel.classList.add('wheel-loading');

            fetch(GAS_API_URL, { 
                method: "POST", headers: { "Content-Type": "text/plain" }, 
                body: JSON.stringify({ action: 'playGame', userId: currentUserProfile.userId, displayName: currentUserProfile.displayName, storeId: currentStoreId }) 
            })
            .then(res => res.json())
            .then(data => {
                if(data.status !== 'success') {
                    wheel.classList.remove('wheel-loading');
                    Swal.fire('éŒ¯èª¤', data.message, 'error');
                    isSpinning = false;
                    document.getElementById('spinBtn').style.opacity = 1;
                    return;
                }
                
                wheel.classList.remove('wheel-loading');
                const targetDeg = (data.targetIndex * 60) + 30; 
                const finalRotate = 1800 + (360 - targetDeg); 

                void wheel.offsetWidth; 

                wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
                wheel.style.transform = `rotate(${finalRotate}deg)`;

                setTimeout(() => {
                    updateBalanceUI(data.newBalance);
                    
                    if(data.prize === "éŠ˜è¬æƒ é¡§") {
                        Swal.fire({ title: 'çœŸå¯æƒœ...', text: 'é€™æ¬¡æ²’ä¸­çï¼Œå†æ¥å†å²ï¼', icon: 'info', confirmButtonColor: '#006633' });
                        resetWheel(targetDeg);
                    } else {
                        // === ä¿®æ”¹è™•ï¼šä¸­çåªéœ€å¡«å¯«åœ°å€ ===
                        Swal.fire({
                            title: 'ğŸ‰ æ­å–œä¸­çï¼',
                            html: `
                                <p>æ‚¨ç²å¾—äº†ï¼š<b style="font-size:1.2rem; color:#d63384">${data.prize}</b></p>
                                <p class="small text-muted mb-3">ç³»çµ±å·²å¸¶å…¥æ‚¨çš„åŸºæœ¬è³‡æ–™ï¼Œè«‹è£œå……<b>æ”¶ä»¶åœ°å€</b>ä»¥åˆ©å¯„é€ï¼š</p>
                                <input id="swal-addr" class="swal2-input" placeholder="è«‹è¼¸å…¥å®Œæ•´æ”¶ä»¶åœ°å€ (å«éƒµéå€è™Ÿ)">
                            `,
                            icon: 'success',
                            confirmButtonText: 'ç¢ºèªé€å‡º',
                            confirmButtonColor: '#006633',
                            allowOutsideClick: false,
                            preConfirm: () => {
                                const addr = document.getElementById('swal-addr').value;
                                if (!addr) {
                                    Swal.showValidationMessage('è«‹å¡«å¯«æ”¶ä»¶åœ°å€æ‰èƒ½é ˜çå–”ï¼');
                                    return false;
                                }
                                return { addr: addr };
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // åªå‚³é€åœ°å€ï¼Œå…¶ä»–è³‡æ–™å¾Œå°å·²æœ‰
                                const infoStr = `æ”¶ä»¶åœ°å€: ${result.value.addr}`;
                                submitWinnerInfo(data.prize, infoStr);
                            }
                            resetWheel(targetDeg);
                        });
                        // === ä¿®æ”¹çµæŸ ===
                    }
                }, 4000);

            })
            .catch(err => {
                wheel.classList.remove('wheel-loading');
                isSpinning = false;
                document.getElementById('spinBtn').style.opacity = 1;
                Swal.fire('éŒ¯èª¤', 'é€£ç·šå¤±æ•—', 'error');
            });
        }

        function submitWinnerInfo(prizeName, infoString) {
            Swal.fire({ title: 'è³‡æ–™å‚³é€ä¸­...', didOpen: () => { Swal.showLoading() } });
            fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'submitWinnerInfo', userId: currentUserProfile.userId, prize: prizeName, info: infoString }) })
            .then(res => res.json()).then(data => { Swal.fire({ icon: 'success', title: 'è³‡æ–™å·²é€å‡º', text: 'æˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨å®‰æ’å¯„é€ï¼', confirmButtonColor: '#006633' }); });
        }

        function resetWheel(targetDeg) {
            const wheel = document.getElementById('wheel'); isSpinning = false; document.getElementById('spinBtn').style.opacity = 1;
            setTimeout(() => { wheel.style.transition = 'none'; wheel.style.transform = `rotate(${360 - targetDeg}deg)`; setTimeout(() => { wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)'; }, 500); }, 500);
        }

        function loadStoreList() {
            const select = document.getElementById('storeSelect');
            fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'getStoreList' }) })
            .then(res => res.json()).then(data => { if(data.status === 'success') { select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡æ¬²æŸ¥è©¢ä¹‹åº—å®¶...</option>'; data.stores.forEach(store => { const option = document.createElement('option'); option.value = store.id; option.text = store.name; select.appendChild(option); }); } }).catch(console.error);
        }

        function doEarn() {
             if (!currentUserProfile || !currentUserProfile.userId) { Swal.fire({ icon: 'warning', title: 'ç³»çµ±é€£ç·šä¸­', text: 'è«‹ç¨ç­‰...', timer: 2000, showConfirmButton: false }); return; }
             if (isViewOnly) return;
             const pointsInput = document.getElementById('inputPoints'); const pinInput = document.getElementById('inputPinEarn'); const btn = document.getElementById('btnEarn');
             if (!pointsInput.value || pointsInput.value <= 0 || !pinInput.value) { Swal.fire({ icon:'warning', title:'è³‡æ–™ä¸å®Œæ•´', text:'è«‹è¼¸å…¥æ¶ˆè²»æ•¸é‡èˆ‡æ ¸éŠ·ç¢¼' }); return; }
             callApi(btn, { action: 'add', userId: currentUserProfile.userId, displayName: currentUserProfile.displayName, points: pointsInput.value, storeId: currentStoreId, pin: pinInput.value }, (data) => { pinInput.value = ""; updateBalanceUI(data.totalPoints); Swal.fire({ icon: 'success', title: 'é›†é»æˆåŠŸ', html: `<div style="font-size:1.2rem">ç²å¾— <b>${data.addedPoints}</b> é»</div>`, timer: 2000, showConfirmButton: false }); });
        }

        function switchTab(tabName) {
            ['earn', 'redeem', 'game', 'history'].forEach(t => { document.getElementById('tab-' + t).classList.remove('active'); document.getElementById('page-' + t).classList.add('d-none'); });
            document.getElementById('tab-' + tabName).classList.add('active'); document.getElementById('page-' + tabName).classList.remove('d-none');
            if (tabName === 'redeem') loadRewards(); if (tabName === 'history') loadHistory();
        }
        
        function loadRewards() {
             if (!currentUserProfile) return; const listDiv = document.getElementById('rewardList'); let targetStoreId = currentStoreId;
             if (isViewOnly) { const selectVal = document.getElementById('storeSelect').value; if (selectVal) targetStoreId = selectVal; else targetStoreId = 'store00'; }
             listDiv.innerHTML = '<div class="text-center w-100 py-4" style="grid-column: span 2;"><div class="spinner-border text-success" role="status"></div><div class="small text-muted mt-2">æ›´æ–°åº«å­˜è³‡è¨Š...</div></div>';
             fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'getRewards', userId: currentUserProfile.userId, storeId: targetStoreId }) })
             .then(res => res.json()).then(data => {
                 listDiv.innerHTML = ""; if(data.userBalance !== undefined) updateBalanceUI(data.userBalance);
                 if (isViewOnly && targetStoreId === 'store00') listDiv.insertAdjacentHTML('beforeend', "<p class='text-center mt-2 text-muted' style='grid-column: span 2;'><i class='fas fa-arrow-up'></i> è«‹é¸æ“‡ä¸Šæ–¹åº—å®¶ä»¥æŸ¥çœ‹åº«å­˜</p>");
                 if (!data.rewards || data.rewards.length === 0) { listDiv.innerHTML = "<p class='text-center w-100 mt-5 text-muted' style='grid-column: span 2;'>ç›®å‰ç„¡å¯å…Œæ›å•†å“</p>"; return; }
                 data.rewards.forEach(item => {
                     const isOutOfStock = item.stock <= 0; const imgUrl = item.image && item.image.startsWith('http') ? item.image : "https://via.placeholder.com/300x200?text=Taiwan+Beer";
                     let btnHtml = isViewOnly ? `<button class="btn btn-secondary btn-redeem" disabled>è«‹è‡³é–€å¸‚å…Œæ›</button>` : (isOutOfStock ? `<button class="btn btn-secondary btn-redeem" disabled>å·²å…Œå®Œ</button>` : `<button class="btn btn-outline-success btn-redeem" onclick="askRedeem('${item.name}', ${item.cost})">å…Œæ›</button>`);
                     let stockText = (targetStoreId === 'store00') ? "è«‹é¸åº—" : `å‰© ${item.stock}`; let stockClass = (targetStoreId !== 'store00' && isOutOfStock) ? "out" : "";
                     const html = `<div class="reward-card"><img src="${imgUrl}" class="reward-img" alt="${item.name}"><div class="reward-body"><div><div class="reward-title">${item.name}</div><div class="reward-meta"><span class="text-warning fw-bold"><i class="fas fa-gem"></i> ${item.cost}</span><span class="stock-badge ${stockClass}">${stockText}</span></div></div>${btnHtml}</div></div>`;
                     listDiv.insertAdjacentHTML('beforeend', html);
                 });
             }).catch(err => { listDiv.innerHTML = "<p class='text-danger text-center w-100' style='grid-column: span 2;'>è¼‰å…¥å¤±æ•—</p>"; });
        }

        function loadHistory() {
             if (!currentUserProfile) return; const listDiv = document.getElementById('historyList');
             listDiv.innerHTML = `<div class="text-center w-100 py-4"><div class="spinner-border text-success" role="status"></div></div>`;
             fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: 'getHistory', userId: currentUserProfile.userId }) })
             .then(res => res.json()).then(data => {
                 listDiv.innerHTML = ""; if (!data.history || data.history.length === 0) { listDiv.innerHTML = "<p class='text-center w-100 mt-5 text-muted'>å°šç„¡äº¤æ˜“ç´€éŒ„</p>"; return; }
                 data.history.forEach(item => { const isPositive = item.points > 0; const pointClass = isPositive ? 'points-add' : 'points-minus'; const pointSign = isPositive ? '+' : ''; const html = `<div class="history-item"><div class="history-info"><div class="history-action">${item.action}</div><div class="history-meta"><span class="me-2"><i class="far fa-clock"></i> ${item.date}</span><span><i class="fas fa-store"></i> ${item.store}</span></div></div><div class="history-points ${pointClass}">${pointSign}${item.points}</div></div>`; listDiv.insertAdjacentHTML('beforeend', html); });
             }).catch(err => { listDiv.innerHTML = "<p class='text-danger text-center w-100'>è¼‰å…¥å¤±æ•—</p>"; });
        }

        function askRedeem(rewardName, cost) {
             Swal.fire({ title: 'å…Œæ›ç¢ºèª', html: `å•†å“ï¼š<b>${rewardName}</b><br>æ‰£é™¤ï¼š<b class="text-danger">${cost}</b> é»<br><br><small>è«‹åº—å“¡è¼¸å…¥æ ¸éŠ·ç¢¼</small>`, input: 'password', inputAttributes: { maxlength: 4, placeholder: 'PIN Code' }, showCancelButton: true, confirmButtonText: 'ç¢ºå®šå…Œæ›', confirmButtonColor: '#006633', cancelButtonText: 'å–æ¶ˆ', reverseButtons: true
             }).then((result) => { if (result.isConfirmed) { if (!result.value) { Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥æ ¸éŠ·ç¢¼', 'error'); return; } callApi(null, { action: 'redeem', userId: currentUserProfile.userId, displayName: currentUserProfile.displayName, storeId: currentStoreId, pin: result.value, rewardName: rewardName, cost: cost }, (data) => { updateBalanceUI(data.totalPoints); loadRewards(); Swal.fire({ icon: 'success', title: 'å…Œæ›æˆåŠŸ', html: `æ‚¨å·²å…Œæ› <b>${data.redeemedItem}</b>`, }); }); } });
        }

        function callApi(btnElement, payload, successCallback) {
             if (btnElement) { btnElement.disabled = true; btnElement.innerText = "è™•ç†ä¸­..."; } Swal.showLoading();
             fetch(GAS_API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) })
             .then(res => res.json()).then(data => { if (btnElement) { btnElement.disabled = false; btnElement.innerText = "ç¢ºèªé›†é»"; } Swal.close(); if (data.status === 'success') successCallback(data); else Swal.fire({ icon:'error', title:'ç„¡æ³•åŸ·è¡Œ', text: data.message });
             }).catch(err => { if (btnElement) btnElement.disabled = false; Swal.fire('éŒ¯èª¤', 'ç¶²è·¯é€£ç·šç•°å¸¸', 'error'); });
        }

        function updateBalanceUI(points) { const el = document.getElementById('headerPoints'); el.innerText = points; el.classList.add('fade-in'); setTimeout(() => el.classList.remove('fade-in'), 500); }
    </script>
</body>
</html>