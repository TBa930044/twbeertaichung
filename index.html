<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TTL 會員專區</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #006633;
            --accent-color: #FFC107;
            --bg-color: #f4f6f8;
        }
        body { background-color: var(--bg-color); font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 80px; }
        
        /* 1. 頂部會員卡區塊 */
        .header-section {
            background: linear-gradient(135deg, #004d26 0%, #008040 100%);
            color: white;
            padding: 25px 20px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,80,0,0.25);
            position: relative;
            overflow: hidden;
        }
        .header-bg-circle {
            position: absolute;
            top: -30px; right: -30px;
            width: 180px; height: 180px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
        }
        .user-greeting { font-size: 0.95rem; opacity: 0.9; margin-bottom: 5px; }
        .store-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            backdrop-filter: blur(4px);
        }
        .balance-card { margin-top: 20px; text-align: center; }
        .balance-number {
            font-size: 3.8rem;
            font-weight: 800;
            color: var(--accent-color);
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
            line-height: 1;
        }
        .balance-label { font-size: 0.9rem; opacity: 0.8; letter-spacing: 1px; }

        /* 2. 卡片與按鈕 */
        .custom-card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            margin-bottom: 15px;
            padding: 25px 20px;
        }
        
        /* 3. 贈品網格排版 */
        .reward-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
        }
        .reward-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }
        .reward-card:active { transform: scale(0.98); }
        .reward-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background-color: #f0f0f0;
        }
        .reward-body {
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .reward-title {
            font-size: 0.95rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            line-height: 1.3;
            height: 2.6em; 
            overflow: hidden;
        }
        .reward-meta {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stock-badge { color: var(--primary-color); font-weight: 500;}
        .stock-badge.out { color: #dc3545; }
        
        /* 4. 底部 Sticky Tab */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: white;
            border-radius: 50px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: flex;
            padding: 5px;
            z-index: 999;
        }
        .nav-btn {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            border-radius: 40px;
            color: #aaa;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0,102,51,0.3);
        }

        /* 輸入框美化 */
        .form-control-custom {
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 14px;
            font-size: 1.1rem;
            text-align: center;
            background-color: #fafafa;
        }
        .form-control-custom:focus {
            border-color: var(--primary-color);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(0,102,51,0.1);
        }
        .btn-action {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(0,102,51,0.3);
        }
        .btn-action:active { transform: scale(0.98); box-shadow: none;}
        .btn-redeem { width: 100%; padding: 6px; font-size: 0.9rem; border-radius: 8px; }

        .d-none { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="header-bg-circle"></div>
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="user-greeting" id="userGreeting">Hi, 會員</div>
                <div style="font-weight:bold; font-size:1.2rem;">
                    <i class="fas fa-beer"></i> 台灣啤酒
                </div>
            </div>
            <div class="store-badge" id="storeDisplay">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
        <div class="balance-card">
            <div class="balance-number" id="headerPoints">---</div>
            <div class="balance-label">目前持有點數</div>
        </div>
    </div>

    <div class="container mt-3">
        <div id="page-earn" class="fade-in">
            <div class="custom-card">
                <h5 class="fw-bold mb-4" style="color:#333;"><i class="fas fa-qrcode me-2 text-success"></i>掃碼集點</h5>
                <div class="mb-3">
                    <label class="text-muted small mb-2 fw-bold">消費瓶數 / 金額</label>
                    <input type="number" id="inputPoints" class="form-control form-control-custom" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label class="text-muted small mb-2 fw-bold">請店員輸入核銷碼</label>
                    <input type="password" id="inputPinEarn" class="form-control form-control-custom" placeholder="PIN Code" maxlength="4">
                </div>
                <button id="btnEarn" class="btn-action" onclick="doEarn()">確認集點</button>
            </div>
        </div>

        <div id="page-redeem" class="d-none fade-in">
            <h5 class="fw-bold ps-2 mb-3 border-start border-4 border-success"> &nbsp;好禮兌換專區</h5>
            <div id="rewardList" class="reward-grid">
                <div class="text-center w-100 py-4" style="grid-column: span 2;">
                    <div class="spinner-border text-success" role="status"></div>
                    <div class="mt-2 text-muted small">Loading...</div>
                </div>
            </div>
            <div style="height: 100px;"></div> 
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" id="tab-earn" onclick="switchTab('earn')">
            <i class="fas fa-camera"></i> 集點
        </div>
        <div class="nav-btn" id="tab-redeem" onclick="switchTab('redeem')">
            <i class="fas fa-gift"></i> 兌換
        </div>
    </div>

    <script>
        // ================= 設定區 =================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYI4M2RuswYcxoMy98Gr8WLinypnvZwrYAwtHsD84rX0unB26FKKx4u0dcuB9Ojo62/exec"; 
        const MY_LIFF_ID = "2008765350-4KBTGWMz"; 
        // ==========================================

        const urlParams = new URLSearchParams(window.location.search);
        const currentStoreId = urlParams.get('store') || 'store01'; 
        let currentUserProfile = null;

        // 初始化
        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                document.getElementById('storeDisplay').innerHTML = `<i class="fas fa-map-marker-alt me-1"></i> ${currentStoreId}`;
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    liff.getProfile().then(profile => { 
                        currentUserProfile = profile;
                        // 1. 更新 UI 暱稱
                        if(profile.displayName) {
                            document.getElementById('userGreeting').innerText = `Hi, ${profile.displayName}`;
                        }
                        // 2. 【關鍵】一進來就默默更新點數，不用等使用者操作
                        refreshPointsOnly();
                    });
                }
            }).catch(err => {
                document.getElementById('storeDisplay').innerText = "系統異常";
            });
        };

        // 新增：只更新點數的輕量函式
        function refreshPointsOnly() {
            if(!currentUserProfile) return;
            // 這裡不顯示 loading，體驗較好 (背景執行)
            fetch(GAS_API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ 
                    action: 'checkBalance', // 呼叫後端新功能
                    userId: currentUserProfile.userId 
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.userBalance !== undefined) {
                    updateBalanceUI(data.userBalance);
                }
            })
            .catch(console.error);
        }

        function switchTab(tabName) {
            document.getElementById('tab-earn').classList.remove('active');
            document.getElementById('tab-redeem').classList.remove('active');
            document.getElementById('tab-' + tabName).classList.add('active');

            document.getElementById('page-earn').classList.add('d-none');
            document.getElementById('page-redeem').classList.add('d-none');
            document.getElementById('page-' + tabName).classList.remove('d-none');

            if (tabName === 'redeem') {
                loadRewards();
            }
        }

        function doEarn() {
            const pointsInput = document.getElementById('inputPoints');
            const pinInput = document.getElementById('inputPinEarn');
            const btn = document.getElementById('btnEarn');
            
            if (!pointsInput.value || pointsInput.value <= 0 || !pinInput.value) {
                Swal.fire({ icon:'warning', title:'資料不完整', text:'請輸入消費數量與核銷碼' });
                return;
            }
            if (!currentUserProfile) return;

            callApi(btn, {
                action: 'add',
                userId: currentUserProfile.userId,
                displayName: currentUserProfile.displayName, 
                points: pointsInput.value,
                storeId: currentStoreId,
                pin: pinInput.value
            }, (data) => {
                pinInput.value = ""; 
                updateBalanceUI(data.totalPoints); 
                Swal.fire({
                    icon: 'success',
                    title: '集點成功',
                    html: `<div style="font-size:1.2rem">獲得 <b>${data.addedPoints}</b> 點</div>`,
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        }

        function loadRewards() {
            if (!currentUserProfile) return;
            const listDiv = document.getElementById('rewardList');
            
            fetch(GAS_API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ 
                    action: 'getRewards',
                    userId: currentUserProfile.userId,
                    storeId: currentStoreId 
                })
            })
            .then(res => res.json())
            .then(data => {
                listDiv.innerHTML = ""; 
                if(data.userBalance !== undefined) updateBalanceUI(data.userBalance);

                if (!data.rewards || data.rewards.length === 0) {
                    listDiv.innerHTML = "<p class='text-center w-100 mt-5 text-muted'>目前無可兌換商品</p>";
                    return;
                }

                data.rewards.forEach(item => {
                    const isOutOfStock = item.stock <= 0;
                    const imgUrl = item.image && item.image.startsWith('http') ? item.image : "https://via.placeholder.com/300x200?text=Taiwan+Beer";
                    
                    const btnHtml = isOutOfStock 
                        ? `<button class="btn btn-secondary btn-redeem" disabled>已兌完</button>`
                        : `<button class="btn btn-outline-success btn-redeem" onclick="askRedeem('${item.name}', ${item.cost})">兌換</button>`;
                    
                    const stockHtml = isOutOfStock
                        ? `<span class="stock-badge out"><i class="fas fa-times-circle"></i> 缺貨</span>`
                        : `<span class="stock-badge"><i class="fas fa-check-circle"></i> 剩 ${item.stock}</span>`;

                    const html = `
                        <div class="reward-card">
                            <img src="${imgUrl}" class="reward-img" alt="${item.name}">
                            <div class="reward-body">
                                <div>
                                    <div class="reward-title">${item.name}</div>
                                    <div class="reward-meta">
                                        <span class="text-warning fw-bold"><i class="fas fa-gem"></i> ${item.cost}</span>
                                        ${stockHtml}
                                    </div>
                                </div>
                                ${btnHtml}
                            </div>
                        </div>
                    `;
                    listDiv.insertAdjacentHTML('beforeend', html);
                });
            })
            .catch(err => {
                listDiv.innerHTML = "<p class='text-danger text-center w-100'>載入失敗</p>";
            });
        }

        function askRedeem(rewardName, cost) {
            Swal.fire({
                title: '兌換確認',
                html: `商品：<b>${rewardName}</b><br>扣除：<b class="text-danger">${cost}</b> 點<br><br><small>請店員輸入核銷碼</small>`,
                input: 'password',
                inputAttributes: { maxlength: 4, placeholder: 'PIN Code' },
                showCancelButton: true,
                confirmButtonText: '確定兌換',
                confirmButtonColor: '#006633',
                cancelButtonText: '取消',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    if (!result.value) { Swal.fire('錯誤', '請輸入核銷碼', 'error'); return; }
                    
                    callApi(null, {
                        action: 'redeem',
                        userId: currentUserProfile.userId,
                        displayName: currentUserProfile.displayName, 
                        storeId: currentStoreId,
                        pin: result.value,
                        rewardName: rewardName,
                        cost: cost
                    }, (data) => {
                        updateBalanceUI(data.totalPoints);
                        loadRewards(); 
                        Swal.fire({
                            icon: 'success',
                            title: '兌換成功',
                            html: `您已兌換 <b>${data.redeemedItem}</b>`,
                        });
                    });
                }
            });
        }

        function callApi(btnElement, payload, successCallback) {
            if (btnElement) { btnElement.disabled = true; btnElement.innerText = "處理中..."; }
            Swal.showLoading();

            fetch(GAS_API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (btnElement) { btnElement.disabled = false; btnElement.innerText = "確認集點"; }
                Swal.close();
                if (data.status === 'success') successCallback(data);
                else Swal.fire({ icon:'error', title:'Oops...', text: data.message });
            })
            .catch(err => {
                if (btnElement) btnElement.disabled = false;
                Swal.fire('錯誤', '網路連線異常', 'error');
            });
        }

        function updateBalanceUI(points) {
            const el = document.getElementById('headerPoints');
            el.innerText = points;
            el.classList.add('fade-in');
            setTimeout(() => el.classList.remove('fade-in'), 500);
        }
    </script>
</body>
</html>